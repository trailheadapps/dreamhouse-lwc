<apex:page id="PipelineManager" standardController="copado__Deployment_Flow__c" extensions="copado.PipelineManagerExtension,copado.BranchManagementExtension,copado.Settings" lightningStylesheets="true" sideBar="false" docType="html-5.0" title="Pipeline Manager" showHeader="true">
    <apex:slds />
    <c:GAnalytics />
    <script>
        ga('send', 'pageview', {
          'page': '/PipelineManager',
          'title': 'Pipeline Manager'
        });
    </script>
    <c:IncludeConnectionJsComponent />
    <apex:includeScript value="{!URLFOR($Resource.utils) }" />
    <c:IncludeStaticsResourceComponent addJQuery="true" addUIjs="true" addUIcss="true" addCometdjs="true" addJCometdjs="true" addJSON2js="true" addJSzipjs="true" />
    <apex:includeScript value="{!URLFOR($Resource.JsRemoting) }" />
    <c:IncludeJqxResourceComponent addjqxalljs="true" addjqxWjs="true" addjqxBasecss="true" />
    <apex:includeScript value="{!URLFOR($Resource.PipelineJS) }" />
    <apex:includeScript value="{!URLFOR($Resource.pipelineStreamingService) }" />
    <apex:includeScript value="{!URLFOR($Resource.UserStoryStreamingService) }" />

    <!-- pipeline promotion -->
    <apex:includeScript value="{!URLFOR($Resource.copado__DataTables10,'DataTables10/datatables.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.copado__DataTables10,'DataTables10/datatables.select.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.copado__CopadoChangeManagement, 'Assets/js/jquery.svg.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.copado__CopadoChangeManagement, 'Assets/js/jquery.connectingLine.js')}" />
    <!-- end pipeline promotion -->

    <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DataTables10,'DataTables10/datatables.min.css')}" />
    <link rel="stylesheet" href="{!URLFOR($Resource.CopadoChangeManagement,'Assets/css/deploymentFlowConnections.css')}" />
    <link rel="stylesheet" href="{!URLFOR($Resource.PipelineCSS)}" />

    <script>
        var copadoApp = {
            ns: '{!JSENCODE(namespace)}',
            data: {
                flowId: '{!JSENCODE(Deployment_Flow__c.Id)}',
                isClassic : "{!IF(CONTAINS($User.UIThemeDisplayed, 'Theme4'), false, true)}"
            },
            envConnections: [],
            icons:{
                success: '{!URLFOR($Resource.SetupDashboardIcons, "PipelineSvgIcons/pipeline-check.png")}',
                failed: '{!URLFOR($Resource.SetupDashboardIcons, "PipelineSvgIcons/pipeline-cross.png")}',
                paused: '{!URLFOR($Resource.SetupDashboardIcons, "PipelineSvgIcons/pipeline-paused.png")}',
                conflict: '{!URLFOR($Resource.SetupDashboardIcons, "PipelineSvgIcons/pipeline-warning.png")}'
            }
        };
        var openWarningModal = () => {
            $copado('#deploymentFlowActivationModal').addClass('slds-fade-in-open');
            $copado('#backdropActivationModal').addClass('slds-backdrop--open');
            unlockScreen();
            return false;
        };
        function togglePipelineMode() {
            lockScreen();
            if ('{!JSENCODE(pipelineMode)}' === '{!JSENCODE(MANAGER)}') {
                changePipelineMode();
            } else if ({!NOT(CheckPipelineStepsAuthenticated) }) {
                addWarningToPage("{!JSENCODE($Label.Pipeline_Activate_Pipeline_Prompt)}");
                unlockScreen();
            } else if ({!NOT(currentPipeline.Active__c) }) {
                openWarningModal();
                return false;
            } else {
                changePipelineModeManager();
            }
        };
        var defineVariables = () => {
            ccd.config.ns = copadoApp.ns;
            ccd.config.mode = '{!JSENCODE(pipelineMode)}';
            ccd.config.currentUserId = '{!$User.Id}';
        };
        $copado(document).ready(() => {
            lockScreen();
            if('{!currentPipeline.Id}') {
                calculateFlowSteps();
            }
            defineVariables();
            try {
                if({!currentPipeline.Active__c}) {
                    var streamingSettingsMap = JSON.parse('{!JSENCODE(streamingSettingsJSON)}');
                    var environmentStreamSettings = streamingSettingsMap[ccdStream.config.pushTopicName];
                    if(environmentStreamSettings && environmentStreamSettings[copadoApp.ns + 'Enabled__c']) {
                        console.info('Pipeline streaming is enabled.');
                        ccdStream.statusMap = {
                            'Completed Successfully' : copadoApp.icons.success,
                            'Completed with Errors' : copadoApp.icons.failed,
                            'Paused' : copadoApp.icons.paused,
                            'Outdated' : copadoApp.icons.warning
                        };
                        if(environmentStreamSettings[copadoApp.ns + 'Timeout__c']) {
                            ccdStream.config.duration = ccdStream.config.timeout = environmentStreamSettings[copadoApp.ns + 'Timeout__c'];
                        }
                        ccdStream.config.ns = copadoApp.ns;
                        ccdStream.config.sobjectAccessError = '{!JSENCODE($Label.SObject_Access_Error)}';
                        ccdStream.initStreaming();
                    }
                    var storyStreamSettings = streamingSettingsMap[ccdStoryStream.config.pushTopicName];
                    if(storyStreamSettings && storyStreamSettings[copadoApp.ns + 'Enabled__c']) {
                        console.info('User Story streaming is enabled.');
                        if(storyStreamSettings[copadoApp.ns + 'Timeout__c']) {
                            ccdStoryStream.config.duration = ccdStoryStream.config.timeout = storyStreamSettings[copadoApp.ns + 'Timeout__c'];
                        }
                        ccdStoryStream.config.ns = copadoApp.ns;
                        ccdStoryStream.config.sobjectAccessError = '{!JSENCODE($Label.SObject_Access_Error)}';
                        updateStoryStreamVariables();
                        ccdStoryStream.initStreaming();
                    }
                    window.onbeforeunload = ccdStream ? ccdStream.disconnect : ccdStoryStream ? ccdStoryStream.disconnect : '';
                }
            } catch(err) {
                console.error(err);
            }
        });
        function doOauth(stepId, envId, envName, branch) {
            doAuthentication(stepId, envId, envName, branch, 'false', 'false');
            return false;
        }
        function getUserStoryListForPromotion(envId, toEnvId, action) {
            prepareUserStoriesForPromotion(envId, toEnvId, action);
            return false;
        }
        function closeWarningModal() {
            $copado('#deploymentFlowActivationModal').removeClass('slds-fade-in-open');
            $copado('#backdropActivationModal').removeClass('slds-backdrop--open');
            return false;
        }
        function callHeaderMode() {
            return '{!JSENCODE(pipelineMode)}';
        }


        /*  pipeline promotion */
        function showVarModal() {
            $copado('#eVarBackdrop').addClass('slds-backdrop--open');
            $copado('#eVarModal').addClass('slds-fade-in-open');
            rerenderDatatable();
            unlockScreen();
        };
        function closeVarModal() {
            lockScreen();
            $copado('#eVarModal').removeClass('slds-fade-in-open');
            $copado('#eVarBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }
        function openRebaseModal(){
            prepareRebase();
        }
        function showRebaseModal(elem) {
            if ({!IsRebasePromotionsCreated}) {
                openRebasePromotionsPanel();
            } else{
                $copado('#rebaseBackdrop').addClass('slds-backdrop--open');
                $copado('#rebaseModal').addClass('slds-fade-in-open');
                unlockScreen();
            }
        };
        function closeRebasePromotionsModal(){
            lockScreen();
            $copado('#rebasePromotionsModal').removeClass('slds-fade-in-open');
            $copado('#rebasePromotionsBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }
        function openRebasePromotionsPanel() {
            $copado('#rebasePromotionsModal').addClass('slds-fade-in-open');
            $copado('#rebasePromotionsBackdrop').addClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }
        function closeRebaseModal() {
            $copado('#rebaseModal').removeClass('slds-fade-in-open');
            $copado('#rebaseBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }

        function renderUsToggle(isClicked){
            console.info('rendering user story button');
            var item = $copado('[Id$="sAll"]');
            var isChecked = item.prop('checked');
            if(isChecked === true){
                if(isClicked){
                    $copado('input[name$=selectAll]').prop('checked',true);
                    item.attr('title','{!JSENCODE($Label.Unselect_All_User_Stories)}');
                    selectAllRebaseUserStoryBoxes(true);
                }
            } else {
                if(isClicked){
                    $copado('input[name$=selectAll]').prop('checked',false);
                    item.attr('title','{!JSENCODE($Label.Select_All_User_Stories)}');
                    selectAllRebaseUserStoryBoxes(false);
                }
            }
        }
        function renderEnvToggle(isClicked){
            console.info('rendering environment button');
            var item = $copado('[Id$="sAll"]');
            var isChecked = item.prop('checked');
            if(isChecked === true){
                if(isClicked){
                    selectAllRebaseEnvironmentBoxes(true);
                }

            } else {
                if(isClicked){
                    selectAllRebaseEnvironmentBoxes(false);
                }
            }
        }
        function renderOvrToggle(isClicked){
            console.info('rendering Overwrite button');
            var item = $copado('[Id$=toggleOverwriteSelection]');
            var isSideList = item.attr('data-isSelected');
            item.html("");
            if(isSideList === "true"){
                if(isClicked){
                    console.log('renderOvrToggle:::toggleRebaseAlgorithm:::',true);
                    toggleRebaseAlgorithm(true);
                }
                item.attr('data-isSelected',false);
                item.text('{!JSENCODE($Label.Disable_Auto_Selection_Overwrite)}');
                item.html(item.html());
            }else{
                if(isClicked){
                    console.log('renderOvrToggle:::toggleRebaseAlgorithm:::',false);
                    toggleRebaseAlgorithm(false);
                }
                item.attr('data-isSelected',true);
                item.text('{!JSENCODE($Label.Enable_Auto_Selection_Overwrite)}')
                item.html(item.html());
            }
        }

        function selectAllRebaseEnvironmentBoxes(isChecked){
            $copado('input[data-chb-type="environment"]').each(function(){
                $copado(this).prop('checked',isChecked);
                selectAllRebaseEnvironments($copado(this));
            });
        }
        function selectEverythinginRebase(elem){
            renderUsToggle(true);
            renderEnvToggle(true);
        }

        function selectAllRebaseEnvironments(elem){
            var envId = $copado(elem).attr('name')
            $copado('input[data-envId="'+envId+'"]').each(function(){
                if(!$copado(this).prop('disabled')){
                    $copado(this).prop('checked', $copado(elem).prop('checked'));
                }
            })
        }
        function selectAllRebaseUserStoryBoxes(isChecked){
            $copado('input[data-chb-type="userStory"]').each(function(){
                $copado(this).prop('checked', isChecked);
                selectAllRebaseUserStories($copado(this));
            })
        }

        function selectAllRebaseUserStories(elem){
            var userStoryId = $copado(elem).attr('name')
            $copado('input[data-usId="'+userStoryId+'"]').each(function(){
                if(!$copado(this).prop('disabled')){
                    $copado(this).prop('checked', $copado(elem).prop('checked'));
                }
            })
        }

        function toggleRebaseAlgorithm(isChecked){
            console.log('toggleRebaseAlgorithm:::isChecked',isChecked);
            $copado('input[data-defualt-disabled=true]').each(function(){
                console.log('toggleRebaseAlgorithm:::elem',$copado(this));
                if(isChecked){
                    $copado(this).attr('disabled',isChecked);
                    $copado(this).css('filter','invert(75%)');
                } else {
                    $copado(this).removeAttr("disabled");
                    $copado(this).css('filter','invert(0%)');
                }
            })
        }

        function bindLookupChanges() {
            if ($copado('[data-id$=promotionProject]').val() != '') {
                $copado('[data-id$=promotionRelease]').attr('disabled', true);

            } else if ($copado('[data-id$=promotionRelease]').val() != '') {
                $copado('[data-id$=promotionProject]').attr('disabled', true);
            }

            $copado('[data-id$=promotionProject]').on('change', function(e) {
                console.log('Project selection changed');
                lockScreen();
                getUserStories();
            });

            $copado('[data-id$=promotionRelease]').on('change', function(e) {
                console.log('Release selection changed');
                lockScreen();
                getUserStories();
            });
        }

        function bindSelectAll() {
            $copado('#selectAll').on('change', function(e) {
                var table = $copado(e.target).closest('table');
                $copado('td input:checkbox', table).prop('checked', $copado(this).prop('checked'));

                setTimeout(function() {
                    calcDepUS();
                }, 1000);
            });
        }
        /* end pipeline promotion */


        /* pipeline dialog */
        function showApprovalModal(envId) {
            prepareEnvApprovals(envId);
            $copado('#approvalBackdrop').addClass('slds-backdrop--open');
            $copado('#approvalModal').addClass('slds-fade-in-open');
            unlockScreen();
        };
        function closeApprovalModal() {
            lockScreen();
            $copado('#approvalModal').removeClass('slds-fade-in-open');
            $copado('#approvalBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }

        function showDeploymentModal(envId) {
            $copado('#deploymentBackdrop').addClass('slds-backdrop--open');
            $copado('#deploymentModal').addClass('slds-fade-in-open');
            queryDeploymentsPerEnvironment(envId);
            //unlockScreen();
        };
        function closeDeploymentModal() {
            lockScreen();
            $copado('#deploymentModal').removeClass('slds-fade-in-open');
            $copado('#deploymentBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }

        function showModal() {
            $copado('#backdrop').addClass('slds-backdrop--open');
            $copado('#modal').addClass('slds-fade-in-open');
        };

        function closeModal() {
            lockScreen();
            $copado('#modal').removeClass('slds-fade-in-open');
            $copado('#backdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }

        function openPromotionListModal() {
            var message = $copado('.slds-notify__content').text();
            var messageOne = '{!JSENCODE($Label.Pipeline_Environment_500_US_Limit_Message)}';
            var messageTwo = '{!JSENCODE($Label.Pipeline_One_promotion_per_release)}';
            var messageIncludesMessageOne = message.includes(messageOne);
            var messageIncludesMessageTwo = message.includes(messageTwo);
            if(message && !messageIncludesMessageOne && !messageIncludesMessageTwo) {
                unlockScreen();
                return;
            }
            $copado('#promoListBackdrop').addClass('slds-backdrop--open');
            $copado('#promotionListModal').addClass('slds-fade-in-open');
            unlockScreen();
        }

        function closePromotionListModal() {
            $copado('[Id$="depPros"]').removeClass('WarningColor');
            lockScreen();
            $copado('#promotionListModal').removeClass('slds-fade-in-open');
            $copado('#promoListBackdrop').removeClass('slds-backdrop--open');
            unlockScreen();
            return false;
        }

        function switchTab(tabType){
            if(tabType == 'SELENIUM') switchToSelenium();
            if(tabType == 'COMPLIANCE') switchToCompliance();
            if(tabType == 'USERSTORY') switchToUserStory();
        }

        function toggleCurrentButton(currentButton){
            $copado('.activeButton').removeClass('activeButton');
            currentButton.classList.add('activeButton');
        }

        function clearSearchFilter(){
            $copado('.dataTables_filter').find('input[type="search"]').val('').keyup();
        }

        function removeDatatableFilterBox(){
            $copado('#userStoriesTable_filter').remove();
            $copado('#seleniumsTable_filter').remove();
            $copado('#compliancesTable_filter').remove();
        }

        function renderTable(){
            removeDatatableFilterBox();
            var tabDatatable = $copado('[Id$="userStoriesTable"]');
            tabDatatable.dataTable({
                paging:false
            });
            tabDatatable.css("border-top","0");

            var filterObj = $copado('#userStoriesTable_filter');
            reParentFilter(filterObj);
        }
        function renderTable4Selenium(){
            removeDatatableFilterBox();
            var tabDatatable = $copado('[Id$="seleniumsTable"]');
            tabDatatable.dataTable({
                paging:false
            });
            tabDatatable.css("border-top","0");

            var filterObj = $copado('#seleniumsTable_filter');
            reParentFilter(filterObj);
        }
        function renderTable4Compliance(){
            removeDatatableFilterBox();
            var tabDatatable = $copado('[Id$="compliancesTable"]');
            tabDatatable.dataTable({
                paging:false
            });
            tabDatatable.css("border-top","0");

            var filterObj = $copado('#compliancesTable_filter');
            reParentFilter(filterObj);
        }
        function reParentFilter(fobj){
            fobj.appendTo(fobj.parents().find('#tabfilter'));
            fobj.css('float','right');
        }

        function copadoNavigateToUrl(id, url, target) {
            // lightning/any other way to navigate
            if( (typeof sforce != 'undefined') && sforce && (!!sforce.one) ) {
                if(target != '_blank'){
                    sforce.one.navigateToSObject(id, 'detail');
                }else{
                    window.open('/lightning/r/' + id + '/view');
                }
            } else {
                if(target != undefined){
                    window.open(url, target);
                }else{
                    window.open(url, '_blank');
                }
            }
        }

        function selectUnselectAll(tableName, elemid) {
            var table = $copado('#'+tableName);
            $copado('td input:checkbox', table).prop('checked', $copado('#'+elemid).prop('checked'));
        }
        function changeSelectAll(tableName, elemid) {
            var table = $copado('#'+tableName);
            var lst = $copado('td input:checkbox', table);
            var count = 0;
            lst.each(function() {
                if($copado(this).prop("checked") == true) count++ ;
            });
            if(lst.length != count) {
                $copado('#'+elemid).prop("checked", false);
            } else {
                $copado('#'+elemid).prop("checked", true);
            }
            promotionInfo();
        }

        CalculateWidth = function(elem, e) {
            var childObj = $copado(elem).children().first();
            var parObj = childObj.parents().first();
            var count = 1;

            while(parObj.prop("tagName") != 'TH') {
                parObj = parObj.parents().first();
                count++;
            }

            var mouseStart=e.clientX;
            mStart = mouseStart;
            oWidth = parObj.outerWidth();
        };

        SetNewWidth = function(elem, e) {
            var childObj = $copado(elem).children().first();
            var parObj = childObj.parents().first();
            var count = 1;

            while(parObj.prop("tagName") != 'TH') {
                parObj = parObj.parents().first();
                count++;
            }

            var mouseStart = mStart;
            var oldWidth = oWidth

            if(e.clientX > 0){
                var newWidth = e.clientX- parseFloat(mouseStart)+parseFloat(oldWidth);
                parObj.width(newWidth);
            }
        }
        /* end pipeline dialog */


    </script>

    <!-- pipeline promotion and diagram -->
    <style type="text/css">
        .slds-scope .slds-modal__container {
            padding: 0;
        }
        .table.dataTable thead tr {
            background-color: "#e0e1e2";
        }

        /* pipeline diagram */
        .activeButton {
            border-bottom: none !important;
            border-top: 4px solid #3593c6 !important;
        }
        .tabButton {
            width:34%;
            min-width: 250px;
        }
        /* end pipeline diagram */
    </style>
    <!-- end pipeline promotion and diagram -->

    <div class="slds-scope">
        <apex:form id="filterModalForm">
            <apex:actionFunction name="addFilterConditionEntry" action="{!addFilterConditionEntry}" reRender="userStoryFilterSection,addRowButtonContainer,pageMsgs" status="loadingScreen" />
            <apex:actionFunction name="removeFilterConditionEntry" action="{!removeFilterConditionEntry}" reRender="userStoryFilterSection,addRowButtonContainer,pageMsgs" status="loadingScreen" immediate="true">
                <apex:param value="" name="selectedIndex" assignTo="{!selectedConditionIndex}" />
            </apex:actionFunction>
            <apex:actionFunction name="deleteSelectedFilter" action="{!deleteSelectedFilter}"
                                 reRender="filterModalForm,filterManagerPanel,flowStepPanel,calculatedStepsPanel,pageMsgs" status="loadingScreen" onComplete="repositionBoxes();ccd.reRenderFunction();" />
            <apex:actionFunction name="createFromExistingFilter" action="{!createFromExistingFilter}" onComplete="saveFilter();"
                                 reRender="JSModalCodePanel,filterConditionSection,nameInput,pageMsgs" />
            <apex:actionFunction name="saveFilter" action="{!saveFilter}" reRender="flowStepPanel,pageMsgs"
                                 onComplete="assignAndApplySelectedFilter({!filterSaveError || popupHasMessages});" />
            <apex:actionFunction name="applySelectedFilter" action="{!applySelectedFilter}" onComplete="showFilterModal(false); updatePageGraphics();" status="loadingScreen"
                                 reRender="editViewHeader,environmentMultiselectPanel,userStoryFilterSection,footerButtonSection,confirmDeleteHeader,flowStepPanel,calculatedStepsPanel,copadoErrorPanel,pageMsgs" />
            <div class="slds-grid" id="filterModalDiv" style="display: none;">
                <apex:outputPanel layout="block" id="filterConditionSection">
                    <apex:inputField styleClass="shareWithInput" value="{!selectedFilter.thisFilter.copado__Share_With__c}" style="display: none;" />
                    <apex:inputText value="{!selectedConditionIndex}" styleClass="selectedConditionIndex" style="display: none;" />
                    <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open slds-modal_medium">
                        <div class="slds-modal__container">
                            <div class="slds-modal__header">
                                <span class="slds-modal__close">
                                    <img src="{!URLFOR($Resource.SLDS, '/assets/icons/utility/close_60.png')}" onclick="showFilterModal(false);" />
                                </span>
                                <apex:outputPanel id="editViewHeader">
                                    <h2 class="slds-text-heading_medium slds-hyphenate">
                                        <b>{!IF(selectedFilter.thisFilter.Id == null, $Label.copado__Create_New_View, $Label.copado__Edit_View + ': ' + selectedFilter.thisFilter.Name)}</b>
                                    </h2>
                                </apex:outputPanel>
                            </div>
                            <div class="slds-modal__content slds-p-around_medium">
                                <apex:pageMessages id="pageMsgs" />
                                <div class="slds-p-bottom_small slds-border_bottom">
                                    <div class="slds-grid slds-p-bottom_small">
                                        <div class="slds-col slds-size_1-of-3">
                                            <div class="slds-form-element slds-size_1-of-2">
                                                <label class="slds-form-element__label" for="nameInput">
                                                    <b>{!$ObjectType.copado__Filter__c.fields.Name.Label}</b>
                                                    <abbr class="slds-required" title="required"> *</abbr>
                                                </label>
                                                <div class="slds-form-element__control">
                                                    <apex:inputField styleClass="slds-input" id="nameInput" value="{!selectedFilter.thisFilter.Name}" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-3">
                                            <fieldset class="slds-form-element">
                                                <legend class="slds-form-element__legend slds-form-element__label">
                                                    {!$Label.copado__Who_Can_See_This_Filter}
                                                    <abbr class="slds-required" title="required"> *</abbr>
                                                </legend>
                                                <div class="slds-form-element__control">
                                                    <span class="slds-radio">
                                                        <apex:outputPanel layout="none" rendered="{!IF(selectedFilter.thisFilter.Id == null || selectedFilter.thisFilter.copado__Share_With__c == 'Me', '', 'none')}">
                                                            <input type="radio" id="onlyMe" value="Me" name="sharingOption" onclick="setSharingMode(this.value);" checked="checked" />
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!IF(selectedFilter.thisFilter.Id != null && selectedFilter.thisFilter.copado__Share_With__c != 'Me', '', 'none')}">
                                                            <input type="radio" id="onlyMe" value="Me" name="sharingOption" onclick="setSharingMode(this.value);" />
                                                        </apex:outputPanel>
                                                        <label class="slds-radio__label" for="onlyMe">
                                                            <span class="slds-radio_faux"></span>
                                                            <span class="slds-form-element__label">{!$Label.Only_Me}</span>
                                                        </label>
                                                    </span>
                                                    <span class="slds-radio">
                                                        <apex:outputPanel layout="none" rendered="{!IF(selectedFilter.thisFilter.Id != null && selectedFilter.thisFilter.copado__Share_With__c == 'All', '', 'none')}">
                                                            <input type="radio" id="allUsers" value="All" name="sharingOption" onclick="setSharingMode(this.value);" checked="checked" />
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!IF(selectedFilter.thisFilter.Id == null || selectedFilter.thisFilter.copado__Share_With__c != 'All', '', 'none')}">
                                                            <input type="radio" id="allUsers" value="All" name="sharingOption" onclick="setSharingMode(this.value);" />
                                                        </apex:outputPanel>
                                                        <label class="slds-radio__label" for="allUsers">
                                                            <span class="slds-radio_faux"></span>
                                                            <span class="slds-form-element__label">{!$Label.All_Users}</span>
                                                        </label>
                                                    </span>
                                                </div>
                                            </fieldset>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-p-top_medium">
                                    <div class="slds-p-bottom_medium slds-border_bottom">
                                        <div class="slds-p-bottom_small slds-text-heading_small">
                                            {!$Label.Environment_Filters}
                                        </div>
                                        <div class="slds-grid">
                                            <apex:outputPanel layout="block" id="environmentMultiselectPanel" styleClass="slds-col slds-size_8-of-12">
                                                <c:MultiselectPicklist leftLabel="{!$Label.copado__Visible_Environments}" rightLabel="{!$Label.copado__Hidden_Environments}"
                                                                       pleftOptions="{!environmentOptions}" prightOptions="{!environmentsToHide}"
                                                                       size="{!environmentOptions.size}" width="100%" showSortArrows="false" />
                                            </apex:outputPanel>
                                        </div>
                                    </div>
                                    <div class="slds-p-top_small">
                                        <div class="slds-p-bottom_small slds-text-heading_small">
                                            {!$Label.copado__User_Story_Filters}
                                        </div>
                                        <apex:outputPanel layout="block" id="userStoryFilterSection">
                                            <ol>
                                                <apex:actionFunction name="updateInputType" action="{!updateInputType}" reRender="none" onComplete="reRenderInput();" />
                                                <apex:actionFunction name="reRenderInput" reRender="userStoryFilterSection,pageMsgs" onComplete="unlockScreen();" />
                                                <apex:variable var="index" value="{!0}" />
                                                <apex:repeat value="{!selectedFilter.filterConditions}" var="condition">
                                                    <li>
                                                        <div class="slds-grid slds-p-top_medium slds-p-bottom_medium slds-border_bottom">
                                                            <div class="slds-col slds-size_2-of-12 slds-p-right_small">
                                                                <div class="slds-form-element">
                                                                    <div class="slds-form-element__control">
                                                                        <div class="slds-select_container">
                                                                            <apex:selectList multiSelect="false" size="1" value="{!condition.fieldApiName}"
                                                                                             styleClass="slds-select" disabled="{!fieldOptions.size == 0}"
                                                                                             onChange="lockScreen(); updateSelectedFieldType({!index});">
                                                                                <apex:selectOptions value="{!fieldOptions}" />
                                                                            </apex:selectList>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="slds-col slds-size_2-of-12 slds-p-right_small">
                                                                <div class="slds-form-element">
                                                                    <div class="slds-form-element__control">
                                                                        <div class="slds-select_container">
                                                                            <apex:selectList multiSelect="false" size="1" value="{!condition.operator}" styleClass="slds-select">
                                                                                <apex:selectOptions value="{!condition.operatorOptions}" />
                                                                            </apex:selectList>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="slds-col slds-p-right_small">
                                                                <div class="slds-form-element {!IF(condition.fieldType == 'BOOLEAN', 'checkbox', '')}"
                                                                     style="{!IF(condition.fieldType != 'MULTIPICKLIST' && !condition.isReadOnly, 'width: 44%;', '')}">
                                                                    <apex:repeat value="{!fieldOptions}" var="filterOption">
                                                                        <apex:outputPanel layout="block" styleClass="slds-form-element__control" rendered="{!condition.fieldApiName == filterOption.value}">
                                                                            <apex:outputPanel layout="none" rendered="{!condition.fieldApiName != ''}">
                                                                                <apex:inputField styleClass="{!IF(condition.fieldType != 'BOOLEAN', 'slds-input', 'slds-checkbox')}" rendered="{!!condition.isReadOnly}"
                                                                                                 type="{!IF(condition.fieldType == 'INTEGER' || condition.fieldType == 'DOUBLE' || condition.fieldType == 'LONG', 'number', '')}"
                                                                                                 value="{!condition.userStory[condition.fieldApiName]}" required="false"
                                                                                                 showDatePicker="{!IF(condition.fieldType == 'DATE' || condition.fieldType == 'DATETIME', 'true', 'false')}"
                                                                                                 onKeyUp="if({!condition.fieldType == 'INTEGER' || condition.fieldType == 'DOUBLE' || condition.fieldType == 'LONG'}) preventNonNumericInput(this)"
                                                                                                 html-onpaste="if({!condition.fieldType == 'INTEGER' || condition.fieldType == 'DOUBLE' || condition.fieldType == 'LONG'}) preventNonNumericInput(this)" />
                                                                                <apex:outputPanel layout="block" rendered="{!condition.isReadOnly}" style="{!IF(condition.fieldType == 'DATETIME', 'width: 60%;', 'width: 44%;')}">
                                                                                    <c:LightningReadyInputFields sObject="{!selectedFilter.readOnlyFields[condition.fieldApiName]}" field="{!condition.auxiliaryField}" showLabel="false" />
                                                                                </apex:outputPanel>
                                                                            </apex:outputPanel>
                                                                            <apex:outputPanel rendered="{!condition.fieldApiName == ''}">
                                                                                <input type="text" class="slds-input" readonly="true" disabled="disabled" />
                                                                            </apex:outputPanel>
                                                                        </apex:outputPanel>
                                                                    </apex:repeat>
                                                                </div>
                                                            </div>
                                                            <div class="slds-col slds-size_1-of-12 {!IF(condition.fieldType != 'MULTIPICKLIST', 'slds-align-middle', '')}">
                                                                <apex:outputPanel layout="block" id="deleteButtonPanel" styleClass="deleteIcon">
                                                                    <img src="{!URLFOR($Resource.SLDS, '/assets/icons/utility/delete_60.png')}" onclick="removeFilterConditionEntry({!index});" />
                                                                </apex:outputPanel>
                                                            </div>
                                                        </div>
                                                    </li>
                                                    <apex:variable var="index" value="{!index + 1}" />
                                                </apex:repeat>
                                            </ol>
                                        </apex:outputPanel>
                                        <apex:outputPanel layout="block" id="addRowButtonContainer" styleClass="slds-grid slds-p-top_small">
                                            <apex:outputPanel layout="block" styleClass="slds-col slds-size_2-of-12" rendered="{!selectedFilter.filterConditions.size < CONDITION_ENTRY_LIMIT}">
                                                <div class="slds-form-element">
                                                    <div class="slds-form-element__control">
                                                        <input type="button" class="slds-button slds-button_neutral" value="{!$Label.ADD_ROW}" onclick="addFilterConditionEntry();" />
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                            <apex:outputPanel layout="block" styleClass="slds-col" rendered="{!selectedFilter.filterConditions.size >= CONDITION_ENTRY_LIMIT}">
                                                <div class="slds-text-heading_small">
                                                    {!SUBSTITUTE($Label.copado__Filter_Condition_Limit_Reached, '##LIMIT##', TEXT(CONDITION_ENTRY_LIMIT))}
                                                </div>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </div>
                            <div class="slds-modal__footer">
                                <apex:outputPanel layout="block" id="footerButtonSection" styleClass="slds-grid {!IF(selectedFilter.thisFilter.Id == null, 'slds-grid_align-end', '')}">
                                    <div class="slds-col slds-size_1-of-12 slds-col_bump-right" style="display: {!IF(selectedFilter.thisFilter.Id != null, '', 'none')};">
                                        <input type="button" class="slds-button slds-button_destructive" value="{!$Label.DELETE}" onclick="showConfirmFilterDeletion(true);" />
                                    </div>
                                    <div class="slds-col slds-size_1-of-10">
                                        <input type="button" class="slds-button slds-button_outline-brand" value="{!$Label.Cancel}" onclick="showFilterModal(false);" />
                                    </div>
                                    <div class="slds-col slds-size_1-of-10 slds-m-left_small slds-text-align_center {!IF(selectedFilter.thisFilter.Id != null, 'criteriaPanelButton', '')}"
                                         style="display: {!IF(selectedFilter.thisFilter.Id != null, '', 'none')};">
                                        <input type="button" class="slds-button slds-button_outline-brand" value="{!$Label.Save_as_New}" onclick="lockScreen(); createFromExistingFilter();" />
                                    </div>
                                    <div class="slds-col slds-size_1-of-10 slds-m-left_small">
                                        <input type="button" class="slds-button slds-button_brand" value="{!$Label.Save}" onclick="lockScreen(); saveFilter();" />
                                    </div>
                                </apex:outputPanel>
                            </div>
                        </div>
                    </section>
                </apex:outputPanel>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </div>
            <span id="confirmDeletePopup" style="display: none;">
                <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <apex:outputPanel layout="block" id="confirmDeleteHeader" styleClass="slds-modal__header slds-border_top slds-border_left slds-border_right">
                            <span class="slds-modal__close">
                                <img src="{!URLFOR($Resource.SLDS, '/assets/icons/utility/close_60.png')}" onclick="showConfirmFilterDeletion(false);" />
                            </span>
                            <h2 class="slds-text-heading_small slds-hyphenate">
                                {!$Label.DELETE + ' ' + selectedFilter.thisFilter.Name}?
                            </h2>
                        </apex:outputPanel>
                        <div class="slds-modal__content slds-border_bottom slds-border_left slds-border_right">
                            <div class="slds-grid slds-grid_align-center slds-p-vertical_small">
                                <div class="slds-col slds-p-right_small">
                                    <input type="button" class="slds-button slds-button_brand" value="{!$Label.NO}" onclick="showConfirmFilterDeletion(false);" />
                                </div>
                                <div class="slds-col">
                                    <input type="button" class="slds-button slds-button_outline-brand" value="{!$Label.YES}" onclick="showConfirmFilterDeletion(false); deleteSelectedFilter();" />
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </span>
            <apex:outputPanel id="JSModalCodePanel">
                <script>
                    function updateSelectedFieldType(index) {
                        setSelectedIndex(index);
                        updateInputType();
                    }
                    function setSelectedIndex(index) {
                        var selectedConditionIndex = document.querySelector('.selectedConditionIndex');
                        if(selectedConditionIndex) {
                            selectedConditionIndex.value = index;
                        }
                    }
                    function assignAndApplySelectedFilter(error) {
                        if(error) {
                            ccd.reRenderFunction();
                            unlockScreen();
                        } else {
                            applySelectedFilter();
                        }
                    }
                    function showConfirmFilterDeletion(show) {
                        var confirmDeletePopup = document.getElementById('confirmDeletePopup');
                        if(confirmDeletePopup) {
                            confirmDeletePopup.style.display = show ? 'block' : 'none';
                        }
                    }
                    function showFilterModal(show) {
                        var filterModalDiv = document.getElementById('filterModalDiv');
                        if(filterModalDiv) {
                            filterModalDiv.style.display = show ? 'block' : 'none';
                        }
                    }
                    function setSharingMode(sharingMode) {
                        var shareWithInput = document.querySelector('.shareWithInput');
                        if(shareWithInput) {
                            shareWithInput.value = sharingMode;
                        }
                    }
                    function updatePageGraphics() {
                        repositionBoxes();
                        ccd.reRenderFunction();
                        updateStoryStreamVariables();
                    }
                    function preventNonNumericInput(thisInput) {
                        thisInput.value = thisInput.value.replace('[^0-9]','');
                    }

                </script>
            </apex:outputPanel>
        </apex:form>
        <apex:form id="pipelineForm">
            <apex:actionFunction name="changePipelineMode" action="{!changePipelineMode}" reRender="pipelineWrapper" onComplete="ccd.reRenderFunction();" />
            <apex:actionFunction name="changePipelineModeManager" action="{!changePipelineMode}" onComplete="refreshPipeline();" />
            <apex:actionFunction name="assingProId" onComplete="ccd.fromAcf2Open();" action="{!assignCurrentPro}" reRender="dependencyUSComponent">
                <apex:param name="currentProId" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="renderPageMessage" reRender="notify" />
            <apex:actionFunction action="{!recalculate}" name="refreshPipeline" reRender="pipelineWrapper" onComplete="ccd.reRenderFunction();" />
            <apex:actionFunction name="reRenderPipelineWrapper" reRender="filterModalForm, pipelineWrapper" onComplete="ccd.reRenderFunction();" />
            <apex:actionFunction name="closeToastMessage" action="{!closeToastMessage}" reRender="notify" />
            <apex:actionFunction action="{!populateFlowGridMap}" name="calculateFlowSteps" onComplete="repositionBoxes();ccd.isManagerRunning('{!JSINHTMLENCODE(pipelineMode)}');updateStoryStreamVariables();" reRender="calculatedStepsPanel,notify" />
            <apex:actionFunction name="prepareUserStoriesForPromotion" action="{!getPromotableBackPromotableUserStoriesList}" reRender="operationModal,notify" onComplete="showModal();switchToUserStory();">
                <apex:param name="fromId" value="" />
                <apex:param name="toId" value="" />
                <apex:param name="pathType" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="promotableUserStories" action="{!getPromotableUserStoriesCount}" onComplete="backPromotableUserStories();" reRender="noRender" />
            <apex:actionFunction name="backPromotableUserStories" action="{!getBackPromotableUserStoriesCount}" onComplete="ccd.reRenderFunction();" reRender="filterModalForm,pipelineWrapper" />
            <apex:actionFunction name="createOrgCredentials" action="{!createOrgCredential}" reRender="canvasSvg">
                <apex:param value="" name="flowStepId" />
                <apex:param value="" name="envId" />
                <apex:param value="" name="envName" />
                <apex:param value="" name="branch" />
                <apex:param value="" name="newOrg" />
                <apex:param value="" name="useStep" />
            </apex:actionFunction>
            <apex:actionFunction name="doAuthentication" action="{!authenticateEnvironment}" status="loadingScreen" reRender="rerenderNeeded">
                <apex:param value="" name="flowStepId" />
                <apex:param value="" name="envId" />
                <apex:param value="" name="envName" />
                <apex:param value="" name="branch" />
                <apex:param value="" name="newOrg" />
                <apex:param value="" name="useStep" />
            </apex:actionFunction>
            <apex:actionFunction name="updatePipelinePanel" action="{!updatePipeline}" onComplete="updatePageGraphics();" reRender="pipelineWrapper,calculatedStepsPanel" status="loadingScreen" />
            <apex:actionFunction name="addWarningToPage" action="{!addMessageToPage}" reRender="copadoErrorPanel">
                <apex:param value="" name="warningMessage" />
            </apex:actionFunction>
            <apex:actionFunction name="createNewConnectionBehaviorAndBind" action="{!createConnectionBehavior}" reRender="copadoErrorPanel">
                <apex:param value="" name="pipelineStepId" />
                <apex:param value="" name="environmentId" />
                <apex:param value="" name="sourceName" />
                <apex:param value="" name="destinationName" />
            </apex:actionFunction>
            <apex:outputPanel layout="block" id="pipelineWrapper">
                <apex:outputPanel layout="block" id="flowStepPanel" styleClass="slds-scrollable_x">
                    <div class="co-pipeline-container {!IF(CONTAINS($User.UIThemeDisplayed, 'Theme4'), '', 'classic-container')}">
                        <c:CopadoSpinner />
                        <apex:outputPanel id="copadoErrorPanel" layout="none">
                            <c:CopadoErrorPanel pageMessagesMap="{!pageMessagesMap}" />
                        </apex:outputPanel>
                        <!--  Header  -->
                        <div class="slds-page-header slds-page-header_record-home" id="headerPanel">
                            <!-- Message Modals -->
                            <div>
                                <section role="dialog" id="deploymentFlowActivationModal" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_small">
                                    <div class="slds-modal__container">
                                        <header class="slds-modal__header">
                                            <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onClick="closeWarningModal(); return false;">
                                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#close')}" />
                                                </svg>
                                                <span class="slds-assistive-text">{!$Label.CLOSE}</span>
                                            </button>
                                            <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">{!$Label.WARNING}</h2>
                                        </header>
                                        <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="text-align: center">
                                            <apex:outputPanel layout="block" id="errorMessages">
                                                <div class="pageLevelErrors" tabindex="-1" style="display: none">
                                                    <div class="desktop forcePageError" aria-live="assertive">
                                                        <div class="genericNotification">
                                                            <span class="genericError uiOutputText">
                                                                {!$Label.Pipeline_Review_Errors}
                                                            </span>
                                                        </div>
                                                        <ul class="errorsList">
                                                            <li>
                                                                <apex:pageMessage severity="error" title="ERROR: " strength="3" summary="{!errorMessage}" id="theErrorMessage" rendered="{!NOT(ISNULL(errorMessage))}" />
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                            <div class="slds-illustration slds-illustration_small">
                                                <svg class="slds-illustration__svg" viewBox="0 0 454 234" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                        <g transform="translate(2.000000, 2.000000)">
                                                            <g transform="translate(52.500000, 147.000000)">
                                                                <path vector-effect="non-scaling-stroke" d="M18.9209988,1.95433401 L33.259296,51.443436 C33.5666778,52.5043744 32.9557995,53.613617 31.8948612,53.9209988 C31.7139843,53.9734036 31.5266126,54 31.3382972,54 L2.6617028,54 C1.5571333,54 0.661702805,53.1045695 0.661702805,52 C0.661702805,51.8116846 0.688299176,51.6243129 0.74070397,51.443436 L15.0790012,1.95433401 C15.386383,0.893395645 16.4956256,0.282517358 17.556564,0.589899164 C18.2152102,0.780726338 18.7301717,1.29568777 18.9209988,1.95433401 Z"
                                                                      fill="#FFFFFF" fill-rule="nonzero"></path>
                                                                <g stroke-linecap="round" class="slds-illustration__stroke-secondary" stroke-width="3">
                                                                    <polygon vector-effect="non-scaling-stroke" stroke-linejoin="round" points="17 0.324 34 54 0 54"></polygon>
                                                                    <path vector-effect="non-scaling-stroke" d="M17,4.6953125 C17,43.0456294 17,62.6471919 17,63.5 C17,62.6471919 17,43.0456294 17,4.6953125 Z"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M17,29.3239437 C22.3333333,35.7851611 25,39.1184944 25,39.3239437 C25,39.1184944 22.3333333,35.7851611 17,29.3239437 Z" stroke-linejoin="round" transform="translate(21.000000, 34.323944) scale(-1, 1) translate(-21.000000, -34.323944) "></path>
                                                                </g>
                                                            </g>
                                                            <g transform="translate(73.000000, 119.000000)">
                                                                <path vector-effect="non-scaling-stroke" d="M26.6478873,0 L51.879042,84.4273253 C52.1953215,85.4856452 51.5937789,86.5999782 50.535459,86.9162577 C50.3496374,86.9717906 50.1567264,87 49.9627843,87 L3.33299037,87 C2.22842087,87 1.33299037,86.1045695 1.33299037,85 C1.33299037,84.8060578 1.36119976,84.6131469 1.41673264,84.4273253 L26.6478873,0 Z"
                                                                      fill="#FFFFFF" fill-rule="nonzero"></path>
                                                                <g stroke-linecap="round" class="slds-illustration__stroke-secondary" stroke-width="3">
                                                                    <polygon vector-effect="non-scaling-stroke" stroke-linejoin="round" points="26.5 0 52.5 87 0.5 87"></polygon>
                                                                    <path vector-effect="non-scaling-stroke" d="M26.5,2.58642578 C26.5,61.0261034 26.5,90.9972948 26.5,92.5 C26.5,90.9972948 26.5,61.0261034 26.5,2.58642578 Z"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M15.6478873,42 C22.314554,49.078692 25.6478873,52.7453587 25.6478873,53 C25.6478873,52.7453587 22.314554,49.078692 15.6478873,42 Z M27.6478873,68 C36.9812207,57.078692 41.6478873,51.7453587 41.6478873,52 C41.6478873,51.7453587 36.9812207,57.078692 27.6478873,68 Z"
                                                                          stroke-linejoin="round"></path>
                                                                </g>
                                                            </g>
                                                            <g stroke-linecap="round" stroke-linejoin="round" transform="translate(332.500000, 170.000000) scale(-1, 1) translate(-332.500000, -170.000000) translate(276.000000, 151.000000)" class="slds-illustration__stroke-secondary" stroke-width="3">
                                                                <polyline vector-effect="non-scaling-stroke" points="0 38 47.5 0 80.5 26"></polyline>
                                                                <polyline vector-effect="non-scaling-stroke" points="71 17 80.5 9 113 36"></polyline>
                                                            </g>
                                                            <g transform="translate(0.000000, 187.500000)">
                                                                <path vector-effect="non-scaling-stroke" d="M153.962142,26.4644491 C151.225735,20.0143094 144.944776,15.5029106 137.633892,15.5029106 C135.619663,15.5029106 133.683612,15.8453541 131.878328,16.4764392 C128.451481,11.1704266 122.567406,7.66985447 115.883789,7.66985447 C109.491267,7.66985447 103.830159,10.8721423 100.350851,15.7935668 C98.9589956,14.968161 97.3423157,14.4956341 95.6177606,14.4956341 C94.1083143,14.4956341 92.6815102,14.8576334 91.4157672,15.5014039 C87.9975328,6.58722215 79.5098304,0.275259875 69.5804557,0.275259875 C60.4632836,0.275259875 52.5615782,5.59684366 48.6837305,13.3681823 C46.3912034,12.266973 43.8314865,11.6515593 41.1312741,11.6515593 C32.4373504,11.6515593 25.1998844,18.0312998 23.6476214,26.4644491 L153.962142,26.4644491 Z"
                                                                      class="slds-illustration__fill-secondary" fill-rule="nonzero"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M13,25 L143,25 M0,25 L450,25" class="slds-illustration__stroke-secondary" stroke-width="3" stroke-linecap="round"></path>
                                                            </g>
                                                            <g transform="translate(272.293000, 172.055000)">
                                                                <path vector-effect="non-scaling-stroke" d="M165.428708,41.9454545 L0.0995432562,41.9454545 C0.0336614956,41.2089487 0,40.4630069 0,39.7090909 C0,26.2132599 10.7866531,15.2727273 24.0926641,15.2727273 C27.7492016,15.2727273 31.215485,16.0989227 34.3199502,17.5772977 C39.5712028,7.14424616 50.271428,0 62.6175975,0 C76.0636257,0 87.5573893,8.47383452 92.1862485,20.441159 C93.9002755,19.5768947 95.8324059,19.0909091 97.8764479,19.0909091 C100.211783,19.0909091 102.401037,19.7252784 104.285841,20.8333889 C108.997403,14.2263569 116.663488,9.92727273 125.320028,9.92727273 C138.043441,9.92727273 148.627152,19.2146805 150.834755,31.4671412 C151.487388,31.3631046 152.156394,31.3090909 152.837838,31.3090909 C159.117096,31.3090909 164.340238,35.8953699 165.428708,41.9454545 Z"
                                                                      class="slds-illustration__fill-secondary" fill-rule="nonzero"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M32.7065637,40.4454545 L173.706564,40.4454545" class="slds-illustration__stroke-secondary" stroke-width="3" stroke-linecap="round"></path>
                                                            </g>
                                                            <g transform="translate(33.000000, 128.000000)">
                                                                <g transform="translate(106.000000, 0.000000)" fill="#FFFFFF" fill-rule="nonzero">
                                                                    <polygon vector-effect="non-scaling-stroke" points="121.5 48.5 158.5 48.5 158.5 34.5 47.5 34.5 47.5 48.5 93.5 48.5 93.5 69.5 121.5 69.5"></polygon>
                                                                    <path vector-effect="non-scaling-stroke" d="M33.9882812,0.21875 C36.5611979,0.21875 70.6126302,0.21875 136.142578,0.21875 L152.384766,11.1132813 C155.083088,16.811292 155.656656,19.677503 154.105469,19.7119141 C152.554281,19.7463252 116.293865,17.6717809 45.3242187,13.4882812 C35.1940104,4.64192708 31.4153646,0.21875 33.9882812,0.21875 Z"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M32.6708984,2.02246094 L21.5554199,0.374195518 L17.6036034,0.374195518 L5.77148437,7.90429688 C3.09089817,12.6737672 3.09089817,15.2284547 5.77148437,15.5683594 C8.45207058,15.9082641 16.1278518,14.3268839 28.7988281,10.8242188 L42.9921875,7.90429688 L41.0699892,5.68448183 L32.6708984,2.02246094 Z"></path>
                                                                    <rect x="0" y="34" width="48" height="14"></rect>
                                                                </g>
                                                                <g transform="translate(106.000000, 5.000000)" class="slds-illustration__fill-secondary" fill-rule="nonzero">
                                                                    <polygon vector-effect="non-scaling-stroke" points="93.311 43.457 93.311 64.672 120.925 64.672 121.823 44.132 158.5 43.457 158.5 97.5 48.5 97.5 48.5 43.693"></polygon>
                                                                    <path vector-effect="non-scaling-stroke" d="M132.670898,7.66300119e-19 C125.172201,-2.55433373e-19 94.1907552,-2.55433373e-19 39.7265625,7.66300119e-19 L31.8183594,12.5058594 L29.7050781,28.2714844 L157.78125,28.2714844 L157.78125,15.4775391 C148.539714,5.15917969 140.169596,1.78803361e-18 132.670898,7.66300119e-19 Z"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M37.8266602,-3.55271368e-15 C34.4632704,-3.55271368e-15 29.4181858,-3.55271368e-15 22.6914062,-3.55271368e-15 C16.1624349,-3.55271368e-15 9.53808594,3.83528646 2.81835938,11.5058594 L0.705078125,30.2714844 L48.4101562,30.2714844 L48.4101562,14.4775391 L48.1789909,12.3275853 C43.283405,4.10919509 39.832628,-3.55271368e-15 37.8266602,-3.55271368e-15 Z"></path>
                                                                    <rect x="0.5" y="43.5" width="48" height="54"></rect>
                                                                </g>
                                                                <rect class="slds-illustration__stroke-primary" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" x="154.5" y="34.5" width="110" height="68"></rect>
                                                                <polygon vector-effect="non-scaling-stroke" class="slds-illustration__stroke-primary" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="264.5 48.5 264.5 34.5 154.5 34.5 154.5 48.5 199.5 48.5 199.5 69.5 227.5 69.5 227.5 48.5"></polygon>
                                                                <path vector-effect="non-scaling-stroke" d="M130.5,0.5 L234.5,0.5 C251.068542,0.5 264.5,13.9314575 264.5,30.5 L264.5,34.5 L106.5,34.5 L106.5,24.5 C106.5,11.245166 117.245166,0.5 130.5,0.5 Z" class="slds-illustration__stroke-primary"
                                                                      stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M130.5,0.5 C143.754834,0.5 154.5,11.245166 154.5,24.5 L154.5,34.5 L106.5,34.5 L106.5,24.5 C106.5,11.245166 117.245166,0.5 130.5,0.5 Z" class="slds-illustration__stroke-primary" stroke-width="3"
                                                                      stroke-linecap="round" stroke-linejoin="round"></path>
                                                                <rect class="slds-illustration__stroke-primary" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" x="106.5" y="48.5" width="48" height="54"></rect>
                                                                <rect class="slds-illustration__stroke-primary" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" x="106.5" y="34.5" width="48" height="14"></rect>
                                                                <path vector-effect="non-scaling-stroke" d="M219,52 C219,54.765 216.765,57 214,57 C211.235,57 209,54.765 209,52 C209,49.235 211.235,47 214,47 C216.765,47 219,49.235 219,52 Z" class="slds-illustration__fill-primary" fill-rule="nonzero"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M214,55 L214,60" class="slds-illustration__stroke-primary" stroke-width="4" stroke-linecap="round"></path>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="164" cy="58" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="164" cy="93" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="255" cy="58" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="255" cy="93" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="145" cy="58" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="145" cy="93" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="116" cy="58" r="3"></circle>
                                                                <circle vector-effect="non-scaling-stroke" class="slds-illustration__fill-primary" fill-rule="nonzero" cx="116" cy="93" r="3"></circle>
                                                                <path vector-effect="non-scaling-stroke" d="M289.928751,82.2971422 L298,102.518658 L280,102.518658 L288.071249,82.2971422 C288.275982,81.784207 288.857768,81.5343604 289.370703,81.7390942 C289.625359,81.8407378 289.827108,82.0424867 289.928751,82.2971422 Z"
                                                                      class="slds-illustration__fill-primary" fill-rule="nonzero"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M300.428751,89.8132712 L305.5,102.518658 L293.5,102.518658 L298.571249,89.8132712 C298.775982,89.300336 299.357768,89.0504894 299.870703,89.2552232 C300.125359,89.3568668 300.327108,89.5586158 300.428751,89.8132712 Z"
                                                                      class="slds-illustration__fill-primary" fill-rule="nonzero"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M93.4287513,82.2971422 L101.5,102.518658 L83.5,102.518658 L91.5712487,82.2971422 C91.7759825,81.784207 92.3577681,81.5343604 92.8707033,81.7390942 C93.1253588,81.8407378 93.3271077,82.0424867 93.4287513,82.2971422 Z"
                                                                      class="slds-illustration__fill-primary" fill-rule="nonzero" transform="translate(92.500000, 92.093119) scale(-1, 1) translate(-92.500000, -92.093119) "></path>
                                                                <path vector-effect="non-scaling-stroke" d="M76.9287513,89.8132712 L82,102.518658 L70,102.518658 L75.0712487,89.8132712 C75.2759825,89.300336 75.8577681,89.0504894 76.3707033,89.2552232 C76.6253588,89.3568668 76.8271077,89.5586158 76.9287513,89.8132712 Z"
                                                                      class="slds-illustration__fill-primary" fill-rule="nonzero" transform="translate(76.000000, 95.851183) scale(-1, 1) translate(-76.000000, -95.851183) "></path>
                                                                <path vector-effect="non-scaling-stroke" d="M360,102.5 L372,102.5 M0,102.5 L350,102.5" class="slds-illustration__stroke-primary" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                                                            </g>
                                                            <g stroke-linecap="round" transform="translate(180.713492, 71.088189) rotate(-15.000000) translate(-180.713492, -71.088189) translate(153.713492, 52.588189)" class="slds-illustration__stroke-secondary" stroke-width="3">
                                                                <path vector-effect="non-scaling-stroke" d="M31.03567,3.43547751 C31.03567,3.43547751 40.5798276,0.672084646 42.6484417,10.6910579" transform="translate(36.842056, 6.888632) rotate(41.000000) translate(-36.842056, -6.888632) "></path>
                                                                <path vector-effect="non-scaling-stroke" d="M40.4282597,10.1797599 C40.4282597,10.1797599 49.9724173,7.41636703 52.0410314,17.4353402" transform="translate(46.234646, 13.632914) scale(-1, 1) rotate(-41.000000) translate(-46.234646, -13.632914) "></path>
                                                                <path vector-effect="non-scaling-stroke" d="M0.730284783,29.5865514 C0.730284783,29.5865514 10.2744424,26.8231586 12.3430565,36.8421318"></path>
                                                                <path vector-effect="non-scaling-stroke" d="M12.7299435,29.5865514 C12.7299435,29.5865514 22.2741011,26.8231586 24.3427152,36.8421318" transform="translate(18.536329, 33.039706) scale(-1, 1) translate(-18.536329, -33.039706) "></path>
                                                            </g>
                                                            <g transform="translate(258.000000, 0.000000)" class="slds-illustration__stroke-primary">
                                                                <g stroke-width="3">
                                                                    <path vector-effect="non-scaling-stroke" d="M67,120 C67,123.312 64.3135,126 61,126 C57.688,126 55,123.312 55,120 C55,116.688 57.688,114 61,114 C64.3135,114 67,116.688 67,120 Z" fill="#FFFFFF" fill-rule="nonzero"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M52,135 C52,137.208 50.209,139 48,139 C45.792,139 44,137.208 44,135 C44,132.792 45.792,131 48,131 C50.209,131 52,132.792 52,135 Z"></path>
                                                                    <path vector-effect="non-scaling-stroke" d="M96.0568799,0 C78.2900529,0 62.8190358,10.0568662 54.6662185,24.9225726 C49.0099109,20.7996522 42.1151387,18.3495864 34.6598756,18.3495864 C15.5126256,18.3495864 0,34.3231272 0,54.0272817 C0,73.7339036 15.5126256,89.7074443 34.6598756,89.7074443 C35.0735129,89.7074443 35.4822552,89.6556302 35.9007877,89.6408262 C42.1591947,98.9155466 52.5662134,105 64.3683403,105 C72.7414379,105 80.4243239,101.940502 86.4134995,96.8503854 C89.5292414,97.5116317 92.7551235,97.8644609 96.0568799,97.8644609 C122.314287,97.8644609 142,76.3690196 142,49.3467431 C142,22.3219992 122.314287,0 96.0568799,0 Z"
                                                                          fill="#FFFFFF" fill-rule="nonzero" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                </g>
                                                                <g transform="translate(75.999627, 52.000087) rotate(45.000000) translate(-75.999627, -52.000087) translate(59.999627, 16.000087)" stroke-width="6">
                                                                    <circle vector-effect="non-scaling-stroke" cx="15" cy="6" r="6"></circle>
                                                                    <circle vector-effect="non-scaling-stroke" cx="7" cy="18" r="7"></circle>
                                                                    <circle vector-effect="non-scaling-stroke" cx="25" cy="18" r="7"></circle>
                                                                    <path vector-effect="non-scaling-stroke" d="M15,24 L15,72 M12,34 L18,34 M15,55 L25,55 M15,65 L27,65" stroke-linecap="round"></path>
                                                                </g>
                                                            </g>
                                                        </g>
                                                    </g>
                                                </svg>
                                                <div class="slds-text-longform">
                                                    <h3 class="slds-text-heading_medium">{!$Label.Pipeline_Not_Active_Error}</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <footer class="slds-modal__footer">
                                            <button class="slds-button slds-button_neutral" onClick="clearErrMessage(); closeWarningModal(); return false;">{!$Label.CLOSE}</button>
                                            <button class="slds-button slds-button_brand" onClick="lockScreen(); activatePipeline(); return false;">{!$Label.ACTIVATE}</button>
                                        </footer>
                                    </div>
                                </section>
                                <div id="backdropActivationModal" class="slds-backdrop"></div>
                            </div>
                            <apex:actionFunction name="clearErrMessage" action="{!clearErrorMessage}" reRender="errorMessages" />
                            <apex:actionFunction name="activatePipeline" action="{!activatePipeline}" onComplete="closeWarningModal();unlockScreen();" reRender="copadoErrorPanel,pageMsgs" />
                            <apex:outputPanel id="errorResult">
                                <script>
                                    function checkErrorResult() {
                                        var returnErrorMessage = $copado('[Id$=theErrorMessage]');
                                        if(!returnErrorMessage || returnErrorMessage.text() === "") {
                                            closeWarningModal();
                                        }
                                        unlockScreen();
                                        return false;
                                    }

                                </script>
                            </apex:outputPanel>
                            <div class="slds-page-header__row">
                                <div class="slds-page-header__col-title">
                                    <div class="slds-media">
                                        <div class="slds-media__figure">
                                            <apex:image value="{!URLFOR($Resource.copado__DTS_images, 'app_icon.png')}" />
                                        </div>
                                        <div class="slds-media__body">
                                            <div class="slds-page-header__name">
                                                <div class="slds-page-header__name-title">
                                                    <h1>
                                                        <span>{!IF(pipelineMode == MANAGER, $ObjectType.copado__Deployment_Flow__c.Label, $Label.copado__Pipeline_Configuration)}</span>
                                                        <span class="slds-page-header__title">
                                                            <apex:selectList value="{!currentPipeline.Id}" id="pipelinePicklist" size="1" multiselect="false" styleClass="slds-select pipeline-picklist" onChange="updatePipelinePanel();">
                                                                <apex:selectOptions value="{!allPipelines}" />
                                                            </apex:selectList>
                                                        </span>
                                                    </h1>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-page-header__col-actions">
                                    <div class="slds-page-header__controls">
                                        <div class="slds-page-header__control buttons">
                                            <div class="slds-button-group" role="group">
                                                <apex:outputPanel layout="none" rendered="{!pipelineMode == MANAGER}">
                                                    <apex:commandButton onClick="lockScreen();openRebaseModal(); return false;" value="{!$Label.copado__Mass_Back_Promote}" reRender="pageMsgs,headerPanel,filterWrapper" styleClass="slds-button slds-button_neutral" />
                                                    <apex:commandButton onClick="togglePipelineMode(); return false;" styleClass="slds-button slds-button_brand" value="{!IF(pipelineMode == DIAGRAM, $Label.copado__VIEW_PIPELINE, $Label.copado__VIEW_PIPELINE_SETUP)}" reRender="pipelineWrapper, filterManagerPanel"></apex:commandButton>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!pipelineMode == DIAGRAM}">
                                                    <apex:commandButton onClick="togglePipelineMode(); return false;" styleClass="slds-button slds-button_brand toggle-pipeline" value="{!IF(pipelineMode == DIAGRAM, $Label.copado__VIEW_PIPELINE, $Label.copado__VIEW_PIPELINE_SETUP)}" reRender="pipelineWrapper, filterManagerPanel"></apex:commandButton>
                                                    <div class="slds-dropdown-trigger slds-dropdown-trigger_click slds-button_last diagramDropwdown">
                                                        <button class="slds-button slds-button_icon slds-button_icon-border-filled slds-button_icon-x-small diagramActionButton" aria-haspopup="true" title="Show More" type="button">
                                                            <span class="slds-assistive-text">Show More</span>
                                                        </button>
                                                        <div class="slds-dropdown slds-dropdown_right slds-dropdown_actions actions">
                                                            <ul class="slds-dropdown__list" role="menu">
                                                                <li class="slds-dropdown__item" role="presentation">
                                                                    <a href="javascript:void(0);" role="menuitem" tabindex="0">
                                                                        <apex:commandLink onClick="lockScreen();showVarModal();" value="{!$Label.copado__Variables}" reRender="headerPanel,filterWrapper" styleClass="slds-button" style="margin-top: -15px;" /> <!-- margin top is for a on top -->
                                                                    </a>
                                                                </li>
                                                                <li class="slds-dropdown__item" role="presentation">
                                                                    <a href="/{!currentPipeline.Id}" role="menuitem" tabindex="-1" class="slds-button">
                                                                        <span class="slds-truncate" title="{!$Label.VIEW_PIPELINE_RECORD}">{!$Label.VIEW_PIPELINE_RECORD}</span>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--Cards-->
                        <div id="pipelineContainer" class="slds-tabs_default slds-tabs_card slds-m-top_medium bundle-tabs slds-tabs_medium slds-grid slds-grid_vertical slds-grow example-selected">
                            <div id="svgContainer"></div>
                            <div class="wrapper">
                                <apex:outputPanel layout="block" styleClass="form-wrapper" id="filterManagerPanel">
                                    <div class="filter-main-object">
                                        <div class="slds-grid slds-grid_align-end slds-m-around_x-small filter-wrapper">
                                            <div class="slds-col slds-p-right_small slds-text-body_regular slds-align-middle">
                                                <apex:outputPanel layout="none" rendered="{!pipelineMode == MANAGER}">
                                                <apex:commandLink action="{!recalculate}" reRender="pipelineWrapper" onComplete="ccd.reRenderFunction();" status="loadingScreen">
                                                        <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-reload.png')}" /> {!$Label.Refresh_Pipeline}
                                                </apex:commandLink>
                                                </apex:outputPanel>
                                            </div>
                                            <div class="slds-col slds-p-right_small slds-text-body_regular slds-align-middle">
                                                <b>{!$Label.copado__VIEW}:</b>
                                            </div>
                                            <div class="slds-col slds-p-right_small slds-size_small">
                                                <apex:selectList multiSelect="false" size="1" value="{!selectedFilterId}" styleClass="slds-select filterDropdown">
                                                    <apex:selectOptions value="{!filterOptions}" />
                                                    <apex:actionSupport event="onchange" action="{!applySelectedFilter}" reRender="filterModalForm,filterManagerPanel,calculatedStepsPanel,flowStepPanel,pageMsgs"
                                                                        status="loadingScreen" onComplete="updatePageGraphics();" />
                                                </apex:selectList>
                                            </div>
                                            <div class="slds-col">
                                                <div class="slds-dropdown-trigger slds-dropdown-trigger_click more-options filterOptionsMenu">
                                                    <button class="slds-button slds-button_icon slds-button_icon-border-filled" aria-haspopup="true"
                                                            title="More Options" onclick="return false;" id="filterSettings">
                                                        <span>
                                                            <img src="{!URLFOR($Resource.SLDS, '/assets/icons/utility/settings_60.png')}" class="settings" />
                                                        </span>
                                                        <span>
                                                            <img src="{!URLFOR($Resource.SLDS, '/assets/icons/utility/down_60.png')}" class="down-arrow" />
                                                        </span>
                                                    </button>
                                                    <div class="slds-dropdown slds-dropdown_right filterSettingsMenu">
                                                        <ul class="slds-dropdown__list" role="menu" aria-label="Show More">
                                                            <li class="slds-dropdown__header slds-truncate" title="{!$Label.Pipeline_View_Controls}" role="separator">
                                                                <span class="slds-text-title_caps">{!$Label.Pipeline_View_Controls}</span>
                                                            </li>
                                                            <li class="slds-has-divider_top-space" role="separator"></li>
                                                            <li class="slds-dropdown__item" role="presentation">
                                                                <a href="javascript:void(0);" role="menuitem" tabindex="0" onclick="showFilterModal(true);"
                                                                   aria-disabled="{!selectedFilterId != null}">
                                                                    <span class="slds-truncate" title="{!$Label.NEW}">{!$Label.NEW}</span>
                                                                </a>
                                                            </li>
                                                            <li class="slds-dropdown__item" role="presentation">
                                                                <a href="javascript:void(0);" role="menuitem" tabindex="0" onclick="showFilterModal(true);"
                                                                   aria-disabled="{!selectedFilterId == null}">
                                                                    <span class="slds-truncate" title="{!$Label.EDIT}">{!$Label.EDIT}</span>
                                                                </a>
                                                            </li>
                                                            <li class="slds-dropdown__item" role="presentation">
                                                                <a href="javascript:void(0);" role="menuitem" tabindex="-1" onclick="showConfirmFilterDeletion(true);"
                                                                   aria-disabled="{!selectedFilterId == null}">
                                                                    <span class="slds-truncate" title="{!$Label.DELETE}">{!$Label.DELETE}</span>
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                                <div id="minimap"><div id="minimapHeader" class="minimap-header" title="{!$Label.Move_Minimap}">&#x2725;</div></div>
                                <div class="pipeline">
                                    <apex:repeat value="{!allEnvironmentsByStageGroupMap}" var="envByStage">
                                        <div class="column">
                                            <apex:repeat value="{!allEnvironmentsByStageGroupMap[envByStage]}" var="envByGroup">
                                                <apex:outputPanel layout="none">
                                                    <apex:repeat value="{!allEnvironmentsByStageGroupMap[envByStage][envByGroup]}" var="envWrapper">
                                                        <div class="box-container {!CASE(pipelineMode, "manager", "manager", "diagram", "diagram", "")}" id="wrapper_{!IF(envByGroup != 'Final', envWrapper.environmentIdentifier, IF(envWrapper.currentStep.Destination_Environment__c != null, envWrapper.currentStep.Destination_Environment__c, envWrapper.currentStep.Destination_Branch__c))}" data-flowstepid="{!envWrapper.currentStep.Id}" data-floaters="" data-branch="{!envWrapper.currentStep.Branch__c}">
                                                            <apex:outputPanel layout="none" rendered="{!AND(envByGroup != 'Final', OR(AND(pipelineMode == DIAGRAM, envWrapper.currentStep.Connection_Behavior_Override__c != null), pipelineMode == MANAGER))}">
                                                                <div class="connection-info">
                                                                    <div class="{!CASE(pipelineMode, "manager", "commits", "diagram", "connection-behaviour-override", "")} show">
                                                                        <apex:outputPanel layout="none" rendered="{!AND(pipelineMode == MANAGER, envByGroup != 'Final')}">
                                                                            <div class="icon storyCountAhead {!IF(envWrapper.userStoriesAhead== 0, 'disabled', '')}">
                                                                                <div class="button-wrapper">
                                                                                    <button type="button" class="storyCountAheadBtn" onclick="lockScreen();prepareUserStoriesForPromotion('{!envWrapper.currentEnvironment.Id}','{!envWrapper.currentStep.Destination_Environment__c}','merge')">{!envWrapper.userStoriesAhead}</button>
                                                                                </div>
                                                                                <div class="image-wrapper">
                                                                                    <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-arrow.png')}" title="{!$Label.Pipeline_Promote}" />
                                                                                </div>
                                                                            </div>
                                                                            <div class="icon storyCountBehind {!IF(envWrapper.userStoriesBehind == 0, 'disabled', '')}">
                                                                                <div class="button-wrapper">
                                                                                    <button type="button" class="storyCountBehindBtn" onclick="lockScreen();prepareUserStoriesForPromotion('{!envWrapper.currentStep.Destination_Environment__c}','{!envWrapper.currentEnvironment.Id}','pull')">{!envWrapper.userStoriesBehind}</button>
                                                                                </div>
                                                                                <div class="image-wrapper">
                                                                                    <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-arrow.png')}" title="{!$Label.copado__Pipeline_Back_Promote}" />
                                                                                </div>
                                                                            </div>
                                                                        </apex:outputPanel>
                                                                        <apex:outputPanel layout="none" rendered="{!AND(pipelineMode == DIAGRAM, envWrapper.currentStep.Connection_Behavior_Override__c != null)}" style="cursor: pointer;">
                                                                            <div class="minipagelayout" style="opacity: 0;position:fixed;">
                                                                                <apex:outputField value="{!envWrapper.currentStep.Connection_Behavior_Override__c}" />
                                                                            </div>
                                                                            <div class="icon">
                                                                                <div class="image-wrapper ">
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Promotion_Behavior__c == 'Automated'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-infinity.png')}"  />
                                                                                        </a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Promotion_Behavior__c == 'Scheduled'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-clock.png')}" /></a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Promotion_Behavior__c == 'Manual'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-point-hand.png')}" /></a>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                                <div class="image-wrapper-2">
                                                                                    <apex:image url="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-arrow-blue.png')}" styleClass="connection" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Promotion_Behavior__c != null}" />
                                                                                </div>
                                                                            </div>
                                                                            <div class="icon">
                                                                                <div class="image-wrapper">
                                                                                    <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                        <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-shield.png')}" /></a>
                                                                                </div>
                                                                            </div>
                                                                            <div class="icon">
                                                                                <div class="image-wrapper">
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Back_Promotion_Behavior__c == 'Automated'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-infinity.png')}" /></a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Back_Promotion_Behavior__c == 'Scheduled'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-clock.png')}" /></a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Back_Promotion_Behavior__c == 'Manual'}">
                                                                                        <a href="/{!envWrapper.currentStep.Connection_Behavior_Override__c}" target="_blank">
                                                                                            <img class="connection" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-point-hand.png')}" /></a>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                                <div class="image-wrapper-2">
                                                                                    <apex:image url="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-arrow-blue.png')}" styleClass="connection" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__r.Back_Promotion_Behavior__c != null}" />
                                                                                </div>
                                                                            </div>
                                                                        </apex:outputPanel>
                                                                    </div>
                                                                </div>
                                                            </apex:outputPanel>
                                                            <apex:outputPanel rendered="{!AND(envByGroup != 'Final', pipelineMode == DIAGRAM, envWrapper.currentStep.Connection_Behavior_Override__c == null)}">
                                                            <div class="connection-info" onmouseover="ccd.toggleNewConnectionIcon(this); return true;" onmouseout="ccd.toggleNewConnectionIcon(this); return true;">
                                                                    <div class="{!CASE(pipelineMode, "manager", "commits", "diagram", "connection-behaviour-override", "")} hide">
                                                                        <div>
                                                                            <div onclick="lockScreen();createNewConnectionBehaviorAndBind('{!envWrapper.currentStep.Id}', '', '{!JSINHTMLENCODE(IF(envWrapper.currentStep.Source_Environment__r.Name != null, envWrapper.currentStep.Source_Environment__r.Name, envWrapper.currentStep.Branch__c))}', '{!JSINHTMLENCODE(IF(envWrapper.currentStep.Destination_Environment__r.Name != null, envWrapper.currentStep.Destination_Environment__r.Name, envWrapper.currentStep.Destination_Branch__c))}');">
                                                                                <img class="new" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/new-connection.png')}" title="Create new connection" />
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </apex:outputPanel>
                                                            <apex:outputPanel rendered="{!pipelineMode == DIAGRAM}">
                                                                <div class="create-env-btn">
                                                                    <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Id == NULL}" layout="none">
                                                                        <input type="button" onclick="ccd.createOrg('{!envWrapper.currentStep.Id}', '{!envWrapper.currentEnvironment.Id}', '{!JSINHTMLENCODE(envWrapper.currentEnvironment.Name)}', false);" data-branch="undefined" data-parentselector="box_undefined" class="noCreateEnv" value="+" title="{!$Label.Pipeline_Environment_Setup_Should_Be_Complete}" disabled="true" />
                                                                    </apex:outputPanel>
                                                                    <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Id != NULL}" layout="none">
                                                                        <input type="button" onclick="ccd.createOrg('{!envWrapper.currentStep.Id}', '{!envWrapper.currentEnvironment.Id}', '{!JSINHTMLENCODE(envWrapper.currentEnvironment.Name)}', false);" data-branch="undefined" data-parentselector="box_undefined" class="createEnv" value="+" title="{!$Label.Create_new_Environment_Connection}" />
                                                                    </apex:outputPanel>

                                                                </div>
                                                            </apex:outputPanel>
                                                            <div id="box_{!envWrapper.currentEnvironment.Id}" data-branch="{!envWrapper.currentStep.Branch__c}" data-boxid="{!envWrapper.currentStep.Id}" class="env-box">
                                                                <div class="slds-no-flex">
                                                                    <apex:outputPanel rendered="{!pipelineMode == DIAGRAM}">
                                                                        <div class="slds-dropdown-trigger slds-dropdown-trigger_click envActionMenuTrigger">
                                                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled slds-button_icon-x-small envActionButton" aria-haspopup="true" title="Show More" onclick="ccd.openDropdownMenu(this);" type="button">
                                                                                <span class="slds-assistive-text">Show More</span>
                                                                            </button>
                                                                        </div>
                                                                    </apex:outputPanel>
                                                                </div>
                                                                <div class="info">
                                                                    <apex:outputPanel layout="none" rendered="{!pipelineMode == MANAGER}">
                                                                        <div class='status'>
                                                                            <div class='button-wrapper'>
                                                                                <a href="javascript:void(0)" onclick="lockScreen();showDeploymentModal('{!envWrapper.currentEnvironment.Id}');" aria-disabled="{!IF(envWrapper.currentEnvironment.Latest_Deployment_Status__c == null, 'true', 'false')}">
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentEnvironment.Latest_Deployment__r.Paused__c != true}">
                                                                                        <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Latest_Deployment_Status__c == 'Completed Successfully'}">
                                                                                            <img id="deploymentStatus_{!envWrapper.currentEnvironment.Id}" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-check.png')}" />
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Latest_Deployment_Status__c == 'Completed with Errors'}">
                                                                                            <img id="deploymentStatus_{!envWrapper.currentEnvironment.Id}" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-cross.png')}" />
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Latest_Deployment_Status__c == 'Merge Conflict'}">
                                                                                            <img id="deploymentStatus_{!envWrapper.currentEnvironment.Id}" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-warning.png')}" />
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Latest_Deployment_Status__c == 'In progress'}">
                                                                                            <div id="deploymentStatus_{!envWrapper.currentEnvironment.Id}" class='spinner'>
                                                                                                <div role='status' class='slds-spinner slds-spinner_xx-small slds-spinner_brand'>
                                                                                                    <span class='slds-assistive-text'>Loading</span>
                                                                                                    <div class='slds-spinner__dot-a'></div>
                                                                                                    <div class='slds-spinner__dot-b'></div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel rendered="{!AND(envWrapper.currentEnvironment.Latest_Deployment__c == null, envWrapper.currentEnvironment.Latest_Deployment_Status__c == NULL)}">
                                                                                            <img id="noDeploymentStatus_{!envWrapper.currentEnvironment.Id}" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-no-status.png')}" />
                                                                                        </apex:outputPanel>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentEnvironment.Latest_Deployment__r.Paused__c == true}">
                                                                                        <img id="deploymentStatus_{!envWrapper.currentEnvironment.Id}" src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-paused.png')}" />
                                                                                    </apex:outputPanel>
                                                                                </a>
                                                                            </div>
                                                                        </div>
                                                                    </apex:outputPanel>
                                                                    <div class="data">
                                                                        <span id="{!envWrapper.currentEnvironment.Id}_title" class="org" target="_blank" title="{!envWrapper.currentEnvironment.Name}">{!envWrapper.currentEnvironment.Name}</span><br />
                                                                        <apex:outputPanel rendered="{!envByGroup != 'Final'}">
                                                                            <div class="branch" title="{!envWrapper.currentStep.Branch__c}">{!$Label.copado__BRANCH}
                                                                                <span>{!envWrapper.currentStep.Branch__c}</span></div>
                                                                        </apex:outputPanel>
                                                                        <apex:outputPanel rendered="{!envByGroup == 'Final'}">
                                                                            <div class="branch" title="{!envWrapper.currentStep.Destination_Branch__c}">{!$Label.copado__BRANCH}
                                                                                <span>{!envWrapper.currentStep.Destination_Branch__c}</span></div>
                                                                        </apex:outputPanel>
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <apex:outputPanel rendered="{!pipelineMode == DIAGRAM}" layout="none">
                                                                        <hr style="width: 90%;margin: 0 auto;" />
                                                                        <apex:outputPanel layout="none" rendered="{!AND(envWrapper.currentEnvironment.Connection_Behavior__c != null, envWrapper.isDestinationEnv)}">
                                                                            <div class="env-connection-info">
                                                                                <div class="env-connection-behaviour-override">
                                                                                    <div class="minipagelayout" style="opacity: 0;position:fixed;">
                                                                                        <apex:outputField value="{!envWrapper.currentEnvironment.Connection_Behavior__c}" />
                                                                                    </div>
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Promotion_Behavior__c == 'Automated'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-infinity.png')}" />
                                                                                            </apex:outputPanel>
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Promotion_Behavior__c == 'Scheduled'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-clock.png')}" />
                                                                                            </apex:outputPanel>
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Promotion_Behavior__c == 'Manual'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-point-hand.png')}" />
                                                                                            </apex:outputPanel>
                                                                                        </div>
                                                                                        <div>
                                                                                            <img src="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-arrow-blue.png')}" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-shield.png')}" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Back_Promotion_Behavior__c == 'Automated'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-infinity.png')}" />
                                                                                            </apex:outputPanel>
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Back_Promotion_Behavior__c == 'Scheduled'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-clock.png')}" />
                                                                                            </apex:outputPanel>
                                                                                            <apex:outputPanel rendered="{!envWrapper.currentEnvironment.Connection_Behavior__r.Back_Promotion_Behavior__c == 'Manual'}">
                                                                                                <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-point-hand.png')}" />
                                                                                            </apex:outputPanel>
                                                                                        </div>
                                                                                        <div>
                                                                                            <img src="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-arrow-blue.png')}" />
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </apex:outputPanel>
                                                                        <apex:outputPanel layout="none" rendered="{!AND(envWrapper.currentEnvironment.Connection_Behavior__c == null, envWrapper.currentEnvironment.Id != null, envWrapper.isDestinationEnv)}">
                                                                            <div class="env-connection-info" onclick="lockScreen();createNewConnectionBehaviorAndBind('','{!envWrapper.currentEnvironment.Id}', '{!JSINHTMLENCODE(envWrapper.currentEnvironment.Name)}','');">
                                                                                <div title="Click here to create a connection behavior" class="env-connection-behaviour-override" style="filter: grayscale(100%);opacity:60%;">
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-point-hand.png')}" style="filter: grayscale(100%);" />
                                                                                        </div>
                                                                                        <div>
                                                                                            <img src="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-right-arrow-blue.png')}" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-shield.png')}" style="filter: grayscale(100%);" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="icon">
                                                                                        <div style="height:11px;">
                                                                                            <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-point-hand.png')}" style="filter: grayscale(100%);" />
                                                                                        </div>
                                                                                        <div>
                                                                                            <img src="{!URLFOR($Resource.copado__SetupDashboardIcons, 'PipelineSvgIcons/pipeline-left-arrow-blue.png')}" />
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </apex:outputPanel>
                                                                    </apex:outputPanel>
                                                                    <div class="authenticate-icon" style="{!IF(CONTAINS($User.UIThemeDisplayed, 'Theme4'), '', 'margin-top:-15px;')}">
                                                                        <apex:outputPanel layout="none" rendered="{!AND(envWrapper.needsOauth, pipelineMode == DIAGRAM)}">
                                                                            <div onclick="doOauth('{!envWrapper.currentStep.Id}','{!envWrapper.currentEnvironment.Id}', '{!JSINHTMLENCODE(envWrapper.currentEnvironment.Name)}', '{!JSINHTMLENCODE(envWrapper.currentStep.Branch__c)}');">
                                                                                <apex:commandButton title="{!$Label.copado__ADD_OAUTH}" styleClass="btn slds-button" style="color:#3593c6;" status="loadingScreen">
                                                                                    <img src="{!URLFOR($Resource.SetupDashboardIcons, 'PipelineSvgIcons/pipeline-authenticate.png')}" />
                                                                                </apex:commandButton>
                                                                            </div>
                                                                        </apex:outputPanel>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="slds-dropdown slds-dropdown_left slds-dropdown_length-2 slds-dropdown_x-small slds-hide envActionDropdown">
                                                                <ul class="slds-dropdown__list" role="menu">
                                                                    <li class="slds-dropdown__item" role="presentation">
                                                                        <a href="/{!envWrapper.currentEnvironment.Id}" role="menuitem" target="_blank" aria-disabled="{!IF(envWrapper.currentEnvironment.Id == null, true, false)}">
                                                                            <span class="slds-truncate" title="{!$Label.EDIT_ENVIRONMENT}">{!$Label.EDIT_ENVIRONMENT}</span>
                                                                        </a>
                                                                    </li>
                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentEnvironment.Connection_Behavior__c != null}">
                                                                        <li class="slds-dropdown__item" role="presentation">
                                                                            <a href="#" role="menuitem" onclick="lockScreen();cloneConnectionBehaviorBasedonObjectSent('{!envWrapper.currentEnvironment.Id}');">
                                                                                <span class="slds-truncate" title="{!$Label.Detach_Behavior_of_Incoming_Connections}">{!$Label.Detach_Behavior_of_Incoming_Connections}</span>
                                                                            </a>
                                                                        </li>
                                                                    </apex:outputPanel>
                                                                    <apex:outputPanel layout="none" rendered="{!envWrapper.currentStep.Connection_Behavior_Override__c != null}">
                                                                        <li class="slds-dropdown__item" role="presentation">
                                                                            <a href="#" role="menuitem" onclick="lockScreen();cloneConnectionBehaviorBasedonObjectSent('{!envWrapper.currentStep.Id}');">
                                                                                <span class="slds-truncate" title="{!$Label.Detach_Behavior_of_Outgoing_Connection}">{!$Label.Detach_Behavior_of_Outgoing_Connection}</span>
                                                                            </a>
                                                                        </li>
                                                                    </apex:outputPanel>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </apex:repeat>
                                                </apex:outputPanel>
                                            </apex:repeat>
                                        </div>
                                    </apex:repeat>
                                    <apex:actionFunction name="cloneConnectionBehaviorBasedonObjectSent" action="{!deepCloneRelatedConnectionBehavior}" reRender="pipelineWrapper" onComplete="ccd.reRenderFunction();unlockScreen();">
                                        <apex:param name="recordId" value="" />
                                    </apex:actionFunction>
                                </div>
                            </div>
                        </div>
                    </div>
                </apex:outputPanel>
                <apex:outputPanel id="calculatedStepsPanel">
                    <apex:inputHidden value="{!allEnvironmentsByStageGroupMapJson}" id="allEnvJSONMap" />
                    <script>
                        function repositionBoxes() {
                            ccd.data.connections = $copado('[id$="allEnvJSONMap"]').val();
                        }
                        function updateStoryStreamVariables() {
                            var streamingSettingsMap = JSON.parse('{!JSENCODE(streamingSettingsJSON)}');
                            var storyStreamSettings = streamingSettingsMap[ccdStoryStream.config.pushTopicName];
                            if(storyStreamSettings && storyStreamSettings[copadoApp.ns + 'Enabled__c']) {
                                ccdStoryStream.params.pipelineId = '{!currentPipeline.Id}';
                                ccdStoryStream.params.sourceIds = JSON.parse('{!JSENCODE(allSourceIdsJSON)}');
                                ccdStoryStream.params.destinationIds = JSON.parse('{!JSENCODE(allDestinationIdsJSON)}');
                                ccdStoryStream.params.filterJSON = '{!JSENCODE(selectedFilterJSON)}';
                                ccdStoryStream.params.flowStepToEnvJSON = '{!JSENCODE(flowStepToEnvironmentJSON)}';
                                ccdStoryStream.params.allEnvironmentKeyJSON = '{!JSENCODE(allEnvironmentsKeysetJSON)}';
                                ccdStoryStream.params.allEnvironmentToStageJSON = '{!JSENCODE(allEnvironmentsToStageGroupKeysetJSON)}';
                                ccdStoryStream.params.allEnvironmentsMapJSON = '{!JSENCODE(allEnvironmentsMapJSON)}';
                            }
                        }

                    </script>
                </apex:outputPanel>
            </apex:outputPanel>


        <!-- PIPELINE PROMOTION -->
        <apex:actionFunction name="getUserStories" action="{!getPromotableUserStories}" oncomplete="bindSelectAll();bindLookupChanges();unlockScreen();" reRender="fieldSets,GeneralActionButtons"/>
        <apex:actionFunction name="resetModalDOM" action="{!resetModalsDOM}" reRender="fileModal, modal, logsModal" />
        <apex:actionFunction name="closeToast" action="{!closeToastMessage}" reRender="notify" />
        <apex:actionFunction name="prepareRebase" action="{!prepareRebase}" reRender="rebaseModalContent,rebaseMainRender" oncomplete="showRebaseModal();"/>

        <!-- Environment Variables for all environments -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="eVarModal" aria-labelledby="modal-heading-01" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_large" style="height: 100%">
                <div class="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 85%; height: 100%; overflow-x:scroll;">
                        <apex:outputPanel id="EnvVarH" layout="block">
                            <div id="varHeading" style="float: left">
                                <button class="slds-button" onclick="closeVarModal(); return false;"> <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                    </svg>{!$Label.Pipeline_Back_to_Pipeline}</button>

                                <h2 class="slds-text-heading_medium slds-hyphenate" >
                                    {!$Label.copado__Variables}
                                </h2>
                            </div>
                            <apex:outputPanel rendered="{!envVarList.size>0}">
                                <table id="dt4dt" class="compact row-border slds-is-resizable">
                                    <thead>
                                    <tr>
                                        <th class="slds-is-resizable" style="background-color: #fafaf9">
                                            <h2 id="VarHeaderText" class="slds-text-heading_medium slds-hyphenate" style="padding-left:20px">
                                                <apex:outputText value="{!$Label.copado__VarEnv}" />
                                            </h2>
                                        </th>
                                        <th class="slds-is-resizable" style="background-color: #fafaf9">
                                            <h2 id="VarHeaderText" class="slds-text-heading_medium slds-hyphenate" style="padding-left:20px">
                                                <apex:outputText value="{!$Label.copado__VarName}" />
                                            </h2>
                                        </th>
                                        <th class="slds-is-resizable" style="background-color: #fafaf9">
                                            <h2 id="VarHeaderText" class="slds-text-heading_medium slds-hyphenate" style="padding-left:20px">
                                                <apex:outputText value="{!$Label.copado__VarVal}" />
                                            </h2>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <apex:variable value="{!1}" var="count" />
                                    <apex:repeat value="{!envId_envVarsMap}" var="envList">
                                        <apex:repeat value="{!envId_envVarsMap[envList]}" var="env">
                                            <tr>
                                                <td style="{!if(count==1,'padding-top:20px;','padding-top:3px;')} padding-left:28px">
                                                    <apex:outputText value="{!env.environment__r.name}" />
                                                </td>
                                                <td style="{!if(count==1,'padding-top:20px;','padding-top:3px;')} padding-left:28px">
                                                    <apex:outputText value="{!env.name}" />
                                                </td>
                                                <td style="{!if(count==1,'padding-top:20px;','padding-top:3px;')} padding-left:28px">
                                                    <apex:outputText value="{!env.value__c}" />
                                                </td>
                                            </tr>
                                            <apex:variable value="{!count+1}" var="count" />
                                        </apex:repeat>
                                        <apex:variable value="{!1}" var="count" />
                                    </apex:repeat>
                                    </tbody>
                                </table>
                            </apex:outputPanel>
                            <apex:outputPanel rendered="{!envVarList.size<1}">
                                <table>
                                    <tr>
                                        <td colspan="3" style="padding-top:20px;">
                                            <center>
                                                {!$Label.copado__NoEnvVar}
                                            </center>
                                        </td>
                                    </tr>
                                </table>
                            </apex:outputPanel>
                            <script>
                                function rerenderDatatable() {
                                    $copado('#dt4dt').DataTable();
                                    $copado('#dt4dt_length').css({"float": "right" , "margin-right": "12px"});
                                    $copado('input[aria-controls$=dt4dt]').attr('placeholder','use "" for exact search');
                                    var filterObj = $copado('#dt4dt_filter');
                                    filterObj.prependTo(filterObj.parents().find('#dt4dt_wrapper'));
                                    $copado('#dt4dt_filter, #dt4dt_length').wrapAll('<div style="margin-bottom: 10px; padding-bottom: 2rem" />');
                                }
                             </script>
                        </apex:outputPanel>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop" id="eVarBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF Environment Variables for all environments -->

        <!-- Rebase Panel -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="rebaseModal" aria-labelledby="modal-heading-01" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_large" style="height: 100%">
                <apex:outputPanel id="rebaseMainRender" layout="block">
                    <apex:actionFunction name="rebasePromotionsRender" reRender="createdPromotionButtons" oncomplete="unlockScreen();" />
                    <apex:outputPanel id="rebasePromotionsCheck" layout="none" rendered="{!rebasePromotionsCreated}">
                        <script type="text/javascript">
                            $copado(
                                function() {
                                    openRebasePromotionsPanel();
                                    rebasePromotionsRender();
                                }
                            );
                            </script>
                    </apex:outputPanel>
                    <apex:outputPanel layout="none" rendered="{!rebasePromotionsCreated}">
                        <script type="text/javascript">
                            $copado(
                                function() {
                                    rebasePromotionsRender();
                                }
                            );
                            </script>
                    </apex:outputPanel>
                </apex:outputPanel>
                <apex:outputPanel id="rebaseMain" layout="none">
                    <div class="slds-modal__container" style="width: 100% !important;">
                        <apex:outputPanel styleClass="slds-modal__content slds-p-around_medium"  style="min-height: 70%; height: 100%; overflow-x:scroll;" id="rebaseModalContent">
                            <div id="window" style="width:100%">

                                <!-- start Toast Message block -->
                                <!-- Toast Message block repeated from PipelineManager because this page has different scope and extension controller -->
                                <apex:outputPanel layout="block" id="notify">
                                    <apex:outputPanel layout="none" rendered="{!pageMessagesMap != null}">
                                        <apex:repeat value="{!pageMessagesMap}" var="status">
                                            <div class="slds-notify_container slds-is-absolute">
                                                <div class="slds-notify slds-notify_toast slds-theme_{!status}" role="status" >
                                                    <span class="slds-assistive-text">{!status}</span>
                                                    <span class="slds-icon_container slds-icon-utility-warning slds-m-right_small slds-no-flex slds-align-top" title="{!status}">
                                                        <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#'+status)}" />
                                                        </svg>
                                                    </span>
                                                    <div class="slds-notify__content">
                                                        <h2 class="slds-text-heading_small ">
                                                            <apex:repeat value="{!pageMessagesMap[status]}" var="message">
                                                                {!message}
                                                            </apex:repeat>
                                                        </h2>
                                                    </div>
                                                    <div class="slds-notify__close">
                                                        <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onClick="closeToast(); return false;">
                                                            <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#close')}" />
                                                            </svg>
                                                            <span class="slds-assistive-text">Close</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </apex:repeat>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                                <!-- End Toast Message block -->

                                <div class="slds-grid" style="padding-bottom: 10px;">
                                    <div class="slds-col slds-size_1-of-1">
                                        <apex:outputPanel id="rebaseHeader" layout="block" style="float: left">
                                            <button class="slds-button" onclick="lockScreen();closeRebaseModal(); return false;"> <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                                </svg>{!$Label.Pipeline_Back_to_Pipeline}</button>

                                            <h2 id="logsHeaderText" class="slds-text-heading_medium slds-hyphenate" >
                                                        {!$Label.MASS_BACK_PROMOTE_USER_STORIES}
                                            </h2>
                                        </apex:outputPanel>
                                        <apex:actionFunction action="{!createRebasePromotions}" name="createRebasePromotions" reRender="rebaseMessage,rebaseMainRender,rebaseEnvironments,rebasePromotionsPanel,createdPromotionButtons, notify" oncomplete="unlockScreen();" />
                                        <apex:actionFunction action="{!createRebasePromotionsAndDeploy}" name="createRebasePromotionsAndDeploy" reRender="rebaseMessage,rebaseMainRender,rebaseEnvironments,rebasePromotionsPanel,createdPromotionButtons, notify" oncomplete="unlockScreen();" />
                                        <apex:outputPanel id="rebasePromotionButtons" layout="block" style="float: right; margin-top: 18px;">
                                            <apex:outputText value="{!$Label.copado__MASS_BP_DISABLE_AUTOSELECT_WARNING}" style="text-align: left;color:orange;" rendered="{!showHiddenCheckboxes}" />

                                            <apex:outputPanel rendered="{!AND(rebaseUserStoriesWrapper.size > 0, OR(AND(NOT(ISNULL(rebaseProject)), rebaseProject != '--None--'),AND(NOT(ISNULL(rebaseRelease)), rebaseRelease != '--None--')))}" layout="none" id="rebaseButtons">
                                                <apex:commandLink action="{!goToPromotions}" rendered="{!rebasePromotionKeySize > 0}" target="_blank" value="{!$Label.copado__Go_To_Promotions}" onclick="lockScreen();" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" oncomplete="unlockScreen();" reRender="rebaseMainRender" />
                                                <apex:commandLink target="_blank" value="{!$Label.copado__Pipeline_Back_Promote}" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}" onclick="lockScreen();" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" id="createRebasePromotions" oncomplete="createRebasePromotions();" reRender="noRender" />
                                                <apex:commandLink target="_blank" value="{!$Label.copado__Pipeline_Back_Promote_and_Deploy}" onclick="lockScreen();" styleClass="slds-button slds-button_brand slds-m-horizontal_small" id="createRebasePromotionsAndDeploy" oncomplete="createRebasePromotionsAndDeploy();" reRender="noRender" />
                                            </apex:outputPanel>
                                            <apex:outputPanel layout="block" rendered="{!rebaseUserStoriesWrapper.size == 0}">
                                                <apex:commandLink action="{!goToPromotions}" rendered="{!rebasePromotionKeySize > 0}" target="_blank" value="{!$Label.copado__Go_To_Promotions}" onclick="lockScreen();" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" oncomplete="unlockScreen();" reRender="rebaseMainRender" />
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </div>
                                </div>
                                <div class="slds-grid" style="padding-bottom: 10px;">
                                    <div class="slds-col" style="width: 0%;">
                                        <label class="slds-form-element__label" for="rebaseSourceList">
                                            <span>{!$Label.copado__SOURCE_ENVIRONMENT}</span>
                                        </label>
                                        <apex:selectList id="rebaseSourceList" html-data-id="rebaseSourceList" onChange="lockScreen();rebaseAcf();" value="{!rebaseSource}" multiselect="false" size="1" styleClass="slds-select">
                                            <apex:selectOptions value="{!rebaseSourceEnvironments}" />
                                        </apex:selectList>
                                        <apex:actionFunction name="rebaseAcf" oncomplete="renderUsToggle(false);renderEnvToggle(false);renderOvrToggle(false);unlockScreen();" action="{!getRebaseUserStories}" reRender="rebaseEnvironments,rebasePromotionButtons,projectRelease,tableButtons,asd" />
                                    </div>
                                    <div class="slds-col">&nbsp;</div> <!--empty column for column/row alignment -->
                                </div>
                                <apex:outputPanel id="projectRelease" styleClass="slds-grid" style="padding-bottom: 15px;">
                                    <div class="slds-col" style="padding-right: 10px;">
                                        <label class="slds-form-element__label" for="projectPicklist">
                                                {!$ObjectType.copado__Promotion__c.fields.copado__Project__c.Label}
                                            </label>
                                        <apex:selectList id="projectPicklist" html-data-id="promotionProject" onChange="lockScreen();projectAcf();" value="{!rebaseProject}" multiselect="false" size="1" styleClass="slds-select">
                                            <apex:selectOptions value="{!projects}" />
                                        </apex:selectList>
                                        <apex:actionFunction name="projectAcf" oncomplete="renderUsToggle(false);renderEnvToggle(false);renderOvrToggle(false);renderMassBackDatatable();unlockScreen();" action="{!getRebaseUserStories}" reRender="rebaseEnvironments,rebasePromotionButtons,tableButtons" />
                                    </div>
                                    <div class="slds-col" style="padding-left: 10px;">
                                        <label class="slds-form-element__label" for="releasePicklist">
                                                {!$ObjectType.copado__Promotion__c.fields.copado__Release__c.Label}
                                            </label>
                                        <apex:selectList id="releasePicklist" html-data-id="promotionRelease" onChange="lockScreen();releaseAcf();" value="{!rebaseRelease}" multiselect="false" size="1" styleClass="slds-select">
                                            <apex:selectOptions value="{!releases}" />
                                        </apex:selectList>
                                        <apex:actionFunction name="releaseAcf" oncomplete="renderUsToggle(false);renderEnvToggle(false);renderOvrToggle(false);unlockScreen();" action="{!getRebaseUserStories}" reRender="rebaseEnvironments,rebasePromotionButtons,tableButtons" />
                                    </div>
                                </apex:outputPanel>
                                <div>
                                    <apex:outputPanel id="tableButtons" layout="block" style="border-bottom: 2px solid #3593c6;">
                                        <apex:outputPanel layout="block" rendered="{!AND(rebaseUserStoriesWrapper.size > 0, OR(AND(NOT(ISNULL(rebaseProject)), rebaseProject != '--None--'),AND(NOT(ISNULL(rebaseRelease)), rebaseRelease != '--None--')))}">
                                            <div class="slds-grid" style="padding-bottom: 15px; text-align: right;">
                                                <div class="slds-col">
                                                    <apex:commandLink html-data-isSelected="true" html-data-type="OVR" value="{!$Label.copado__Enable_Auto_Selection}" onclick="lockScreen();renderOvrToggle(true);" immediate="true" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" id="toggleOverwriteSelection" action="{!toggleRebaseListView}" reRender="rebasePromotionButtons" oncomplete="unlockScreen();"/>
                                                </div>
                                            </div>
                                        </apex:outputPanel>
                                    </apex:outputPanel>
                                    <apex:outputPanel id="rebaseEnvironments" layout="block" style="padding-top: 10px;">
                                        <apex:outputPanel layout="block" rendered="{!AND(rebaseSources.size > 0,rebaselistView == false)}">
                                            <div class="slds-resizable slds-scrollable_x" style="width: 100%;">
                                                <table id="massback" style="width:100% !important" class="slds-table slds-table_resizable-cols slds-table_striped">
                                                    <thead>
                                                        <tr>
                                                            <td class="slds-modal__header" style="width: 10%;background-color: #fafaf9; text-align: center; border-bottom: 1px solid rgb(221, 219, 218);">
                                                                <input type="checkbox" id="sAll" name="selectAll" title="" onclick="selectEverythinginRebase($copado(this))" checked="checked" />
                                                            </td>
                                                            <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__Mass_Back_Promote}" var="f">
                                                                <th class="headcol slds-is-resizable" style="text-align: left;{!IF(f=='Name','width: 10%;','width: 20%;')}padding-left: 15px; border-bottom: 1px solid rgb(221, 219, 218);">
                                                                    <a href="javascript:void(0);" class="slds-th__action slds-text-link_reset" tabindex="0">
                                                                        <span class="slds-assistive-text">{!$Label.Sort}</span>
                                                                        <span class="slds-truncate" title="Name">{!f.Label}</span>
                                                                        <div class="slds-icon_container">
                                                                            <svg class="slds-icon slds-icon_x-small slds-icon-text-default slds-is-sortable__icon" aria-hidden="true">
                                                                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#arrowdown')}"></use>
                                                                            </svg>
                                                                        </div>
                                                                        <span class="slds-assistive-text" aria-live="assertive" aria-atomic="true"></span>
                                                                    </a>
                                                                    <div class="slds-resizable">
                                                                        <label for="cell-resize-handle-1" class="slds-assistive-text">{!f.Label} column width</label>
                                                                        <input type="range" min="20" max="1000" class="slds-resizable__input slds-assistive-text" id="cell-resize-handle-1" tabindex="0" />
                                                                        <span class="slds-resizable__handle" draggable="true" onmousedown="CalculateWidth(this, event)" ondrag="SetNewWidth(this, event)" ondragend="return false;">
                                                                            <span class="slds-resizable__divider"></span>
                                                                        </span>
                                                                    </div>
                                                                </th>
                                                            </apex:repeat>
                                                            <apex:repeat value="{!rebaseSources}" var="rebaseOrg">
                                                                <th class="slds-is-resizable" style="text-align: left;font-weight: bold;background-color: #fafaf9; padding-top:20px; padding-left:7px; border-bottom: 1px solid rgb(221, 219, 218)">
                                                                    <a href="javascript:void(0);" class="slds-th__action slds-text-link_reset" tabindex="0">
                                                                        <span class="slds-assistive-text">{!$Label.Sort}</span>
                                                                        <apex:inputCheckbox value="{!rebaseOrg.isSelected}" html-name="{!rebaseOrg.step.copado__Source_Environment__c}" html-data-chb-type="environment" onchange="selectAllRebaseEnvironments($copado(this))" />
                                                                        <apex:outputText style="margin-left: 2px; " value="{!rebaseOrg.step.Source_Environment__r.Name}" />
                                                                        <div class="slds-icon_container">
                                                                            <svg class="slds-icon slds-icon_x-small slds-icon-text-default slds-is-sortable__icon" aria-hidden="true">
                                                                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#arrowdown')}"></use>
                                                                            </svg>
                                                                        </div>
                                                                        <span class="slds-assistive-text" aria-live="assertive" aria-atomic="true"></span>
                                                                    </a>
                                                                    <div class="slds-resizable">
                                                                        <label for="cell-resize-handle-1" class="slds-assistive-text">{!rebaseOrg.step.Source_Environment__r.Name} column width</label>
                                                                        <input type="range" min="20" max="1000" class="slds-resizable__input slds-assistive-text" id="cell-resize-handle-1" tabindex="0" />
                                                                        <span class="slds-resizable__handle" draggable="true" onmousedown="CalculateWidth(this, event)" ondrag="SetNewWidth(this, event)" ondragend="return false;">
                                                                            <span class="slds-resizable__divider"></span>
                                                                        </span>
                                                                    </div>
                                                                </th>
                                                            </apex:repeat>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    <apex:repeat value="{!rebaseUserStoriesWrapper}" var="us">
                                                        <tr>
                                                            <td class="headcol slds-is-resizable" style="text-align: center">
                                                                <apex:inputCheckbox id="usCheckbox" value="{!us.isSelected}" html-name="{!us.userStory.Id}" html-data-chb-type="userStory" onchange="selectAllRebaseUserStories($copado(this))" />
                                                            </td>
                                                            <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__Mass_Back_Promote}" var="fld">
                                                                <td class="headcol slds-is-resizable" style="text-align: left;overflow-wrap: break-word;padding-top:20px">
                                                                    <div class="slds-truncate" title="{!us.userStory[fld]}">
                                                                        <apex:outputLink value="{!URLFOR($Action.copado__User_Story__c.View,us.userStory.Id)}" rendered="{!fld.fieldPath == 'Name'}" target="_blank">
                                                                            {!us.userStory.Name}
                                                                        </apex:outputLink>
                                                                        <apex:outputField value="{!us.userStory[fld.fieldPath]}" rendered="{!fld.fieldPath != 'Name'}"/>
                                                                    </div>
                                                                </td>
                                                            </apex:repeat>
                                                            <apex:repeat value="{!rebaseSources}" var="rebaseOrg">
                                                                <td class="headcol slds-is-resizable" style="text-align: left;padding-top:20px">
                                                                    <apex:inputCheckbox disabled="{!NOT(OR(usEnvironmentAvailabilityMap[us.userStory.Id][rebaseOrg.step.copado__Source_Environment__c].isAvailable,showHiddenCheckboxes))}" style="{!IF(NOT(OR(usEnvironmentAvailabilityMap[us.userStory.Id][rebaseOrg.step.copado__Source_Environment__c].isAvailable,showHiddenCheckboxes)),'filter: invert(75%);','')}" html-data-envId="{!rebaseOrg.step.copado__Source_Environment__c}" html-data-usId="{!us.userStory.Id}" value="{!usEnvironmentAvailabilityMap[us.userStory.Id][rebaseOrg.step.copado__Source_Environment__c].isSelected}" html-data-defualt-disabled="{!NOT(usEnvironmentAvailabilityMap[us.userStory.Id][rebaseOrg.step.copado__Source_Environment__c].isAvailable)}" />
                                                                </td>
                                                            </apex:repeat>
                                                        </tr>
                                                    </apex:repeat>
                                                    </tbody>
                                                </table>
                                                <script>
                                                    function renderMassBackDatatable(){
                                                        $copado('#massback').DataTable({
                                                            "pageLength": 100,
                                                            "lengthChange": false
                                                        } );
                                                        $copado(".dataTables_filter").css("margin-bottom","10px");
                                                    }
                                                </script>
                                            </div>
                                            <apex:outputPanel rendered="{!rebaseUserStoriesWrapper.size == 0}">
                                                <center>
                                                    <p>
                                                        <apex:outputText value="{!$Label.copado__NO_US_TO_SELECT}" />
                                                    </p>
                                                </center>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </apex:outputPanel>
                                </div>
                            </div>
                        </apex:outputPanel>
                    </div>
                </apex:outputPanel>
            </section>
            <div class="slds-backdrop" id="rebaseBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF Rebase Panel -->

        <!-- Rebase Promotions Panel -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="rebasePromotionsModal" class="slds-modal slds-modal_large" style="height: 100%">
                <div class="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 70%; height: 100%; overflow-x:scroll;">
                        <div style="float:left; margin-bottom: 10px;" id="head">
                            <button class="slds-button" onclick="lockScreen();resetPromotions(); return false;"> <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                </svg>{!$Label.copado__CLOSE}</button>
                            <apex:outputPanel id="rebasePromotionsHeader" layout="block" >
                                <h2 id="logsHeaderText" class="slds-text-heading_medium slds-hyphenate">
                                    <apex:outputText value="{!$Label.copado__CREATED_BACK_PROMOTIONS}" />
                                </h2>
                            </apex:outputPanel>
                        </div>
                        <apex:actionFunction name="resetPromotions" action="{!resetPromotions}" oncomplete="closeRebasePromotionsModal();unlockScreen();" reRender="rebasePromotionButtons,rebaseMain" />
                        <apex:actionFunction name="deployPromotions" action="{!deployPromotions}" reRender="rebasePromotionsPanel" oncomplete="reRenderDeploy();unlockScreen();" />
                        <apex:actionFunction name="reRenderDeploy" reRender="createdPromotionButtons, notify" />
                        <apex:outputPanel id="createdPromotionButtons" layout="block" style="float: right">
                            <apex:outputPanel rendered="{!promotionOnly}">
                                <button class="slds-button slds-button_neutral" onclick="lockScreen();resetPromotions(); return false;">{!$Label.copado__Prepare_Another_Promotion}</button>
                                <button class="slds-button slds-button_brand" onclick="lockScreen();deployPromotions(); return false;">{!$Label.copado__Deploy_Promotions}</button>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" id="rebasePromotionsPanel">
                            <apex:actionPoller action="{!checkRebasePromotionsStatuses}" id="rebasePromotionPoller" enabled="{!enabledRebasePromotionPoller}" interval="10" reRender="rebasePromotionsPanel,rebasePromotionPoller" />
                            <table id="masspromo" class="slds-table slds-table_resizable-cols slds-table_striped">
                                <thead>
                                <tr>
                                    <apex:repeat value="{!$ObjectType.copado__Promotion__c.FieldSets.copado__ManageBranchesDialog}" var="pf">
                                        <th class="headcol slds-is-resizable" style="text-align: left;font-weight: bold;background-color: #fafaf9; padding-top:20px; padding-left:7px; border-bottom: 1px solid rgb(221, 219, 218)">
                                            <apex:outputText value="{!pf.Label}" />
                                        </th>
                                    </apex:repeat>
                                    <apex:outputPanel layout="none" rendered="{!AND(!promotionOnly,OR(enabledRebasePromotionPoller,rebaseDeploymentsCompleted))}">
                                        <th class="headcol slds-is-resizable" style="text-align: left;font-weight: bold;background-color: #fafaf9; padding-top:20px; padding-left:7px; border-bottom: 1px solid rgb(221, 219, 218)">
                                            <b>{!$Label.copado__DEPLOYMENT_STATUS}</b>
                                        </th>
                                    </apex:outputPanel>
                                </tr>
                                </thead>
                                <tbody>
                                <apex:repeat var="promotion" value="{!rebasePromotionsMap}">
                                    <tr>
                                        <apex:repeat value="{!$ObjectType.copado__Promotion__c.FieldSets.copado__ManageBranchesDialog}" var="pf">
                                            <td>
                                                <apex:outputPanel rendered="{!pf.fieldPath == 'Name'}">
                                                    <a href="/{!rebasePromotionsMap[promotion].Id}" target="_blank">
                                                        {!rebasePromotionsMap[promotion].Name}
                                                    </a>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!pf.fieldPath != 'Name'}">
                                                    <c:LightningReadyOutputFields SObject="{!rebasePromotionsMap[promotion]}" Field="{!pf.fieldPath}" showLabel="false" dividerBottom="false" customClass="pfFields" htmlTarget="_blank" />
                                                </apex:outputPanel>
                                            </td>
                                        </apex:repeat>
                                        <apex:outputPanel layout="none" rendered="{!AND(!promotionOnly,OR(enabledRebasePromotionPoller,rebaseDeploymentsCompleted))}">
                                            <td style="text-align: center;">
                                                <apex:outputPanel layout="none" rendered="{!rebasePromotionsMap[promotion].Status__c == 'Scheduled'}">
                                                    <div id="statusImg" class="slds-icon_container">
                                                        <svg class="slds-icon slds-icon_small slds-icon-text-default" aria-hidden="true">
                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#clock')}">
                                                            </use>
                                                        </svg>
                                                    </div>
                                                    <script type="text/javascript">
                                                        $copado(function(){
                                                            var item = $copado('[Id$=statusImg]');
                                                            item.html("");
                                                            var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#clock')}";
                                                            var SVG = $copado('<svg/>', {
                                                                class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                            });
                                                            var SVGUse = $copado('<use/>');
                                                            SVGUse.attr('xlink:href', imageURL);
                                                            item.prepend(SVG.append(SVGUse));
                                                            item.html(item.html());
                                                        });

                                                    </script>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!rebasePromotionsMap[promotion].Status__c == 'In Progress'}">
                                                    <img id="statusImg" style="width: 20px;" src="{!URLFOR($Resource.SLDS,'/assets/images/spinners/slds_spinner_brand.gif')}" />
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!rebasePromotionsMap[promotion].Status__c == 'Completed'}">
                                                    <div id="statusImgApproval" class="slds-icon_container">
                                                        <svg class="slds-icon slds-icon_small slds-icon-text-default" aria-hidden="true">
                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/action-sprite/svg/symbols.svg#approval')}">
                                                            </use>
                                                        </svg>
                                                    </div>
                                                    <script type="text/javascript">
                                                        $copado(function(){
                                                            var item = $copado('[Id$=statusImgApproval]');
                                                            item.html("");
                                                            var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/action-sprite/svg/symbols.svg#approval')}";
                                                            var SVG = $copado('<svg/>', {
                                                                class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                            });
                                                            var SVGUse = $copado('<use/>');
                                                            SVGUse.attr('xlink:href', imageURL);
                                                            item.prepend(SVG.append(SVGUse));
                                                            item.html(item.html());
                                                        });

                                                    </script>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!rebasePromotionsMap[promotion].Status__c == 'Completed with errors'}">
                                                    <div id="statusImgClose" class="slds-icon_container">
                                                        <svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/action-sprite/svg/symbols.svg#close')}">
                                                            </use>
                                                        </svg>
                                                    </div>
                                                    <script type="text/javascript">
                                                        $copado(function(){
                                                            var item = $copado('[Id$=statusImgClose]');
                                                            item.html("");
                                                            var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/action-sprite/svg/symbols.svg#close')}";
                                                            var SVG = $copado('<svg/>', {
                                                                class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                            });
                                                            var SVGUse = $copado('<use/>');
                                                            SVGUse.attr('xlink:href', imageURL);
                                                            item.prepend(SVG.append(SVGUse));
                                                            item.html(item.html());
                                                        });
                                                    </script>
                                                </apex:outputPanel>
                                            </td>
                                        </apex:outputPanel>
                                    </tr>
                                </apex:repeat>
                                </tbody>
                            </table>
                            <script>
                                $copado(function renderMassPromoDatatable(){
                                    $copado('#masspromo').DataTable({
                                        "pageLength": 100,
                                        "lengthChange": false,
                                        "ordering": false,
                                        "searching": false
                                    } );
                                });
                            </script>
                        </apex:outputPanel>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop" id="rebasePromotionsBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF PIPELINE PROMOTION -->


        <!-- PIPELINE DIALOG -->
        <!-- deployment modal functions -->
        <apex:actionFunction name="openConflictPage" reRender="copadoErrorPanel,copadoErrorPanelForDialog" action="{!openResolveConflictsPage}" onComplete="closeDeploymentModal();">
            <apex:param name="promId" value="" />
        </apex:actionFunction>
        <!-- Promotion / Back Promotion Panel -->
        <apex:actionFunction name="promotionInfo" action="{!promotionInfo}" reRender="copadoErrorPanelForDialog" />
        <apex:actionFunction name="switchToSelenium" action="{!showSeleniumResultsTab}" onComplete="renderTable4Selenium();unlockScreen();" reRender="fieldSets,GeneralActionButtons" />
        <apex:actionFunction name="switchToCompliance" action="{!showComplianceResultsTab}" onComplete="renderTable4Compliance();unlockScreen();" reRender="fieldSets,GeneralActionButtons" />
        <apex:actionFunction name="switchToUserStory" action="{!showUserStoriesTab}" onComplete="renderTable();unlockScreen();" reRender="fieldSets,GeneralActionButtons" />
        <apex:actionFunction name="prepareEnvApprovals" reRender="approvalRenderPanel" onComplete="rerenderApprovalDatatable()">
            <apex:param name="approvalEnvId" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="queryDeploymentsPerEnvironment" reRender="deploymentRenderPanel" onComplete="rerenderDeploymentDatatable(); unlockScreen();">
            <apex:param name="deploymentEnvId" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="renderPromotionPoller" reRender="promotionPoller" />
        <apex:actionFunction name="resetPromotionList" action="{!resetPromotionList}" oncomplete="renderTable();closePromotionListModal();changeSelectAll('userStoriesTable', 'selectAll');unlockScreen();" reRender="fieldSets,pins" />
        <apex:actionFunction name="deployPromotionList" action="{!deploySelectedPromotions}" reRender="createdPromotionListButtons,createdPromotionListPanel,promotionPoller,copadoErrorPanelForDialog" oncomplete="unlockScreen();" />


        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="modal" aria-labelledby="modal-heading-01" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_large" style="height: 100%">
                <apex:outputPanel layout="block" id="operationModal" styleClass="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 85%; height: 100%; overflow-x:scroll;">
                        <apex:outputPanel id="copadoErrorPanelForDialog" layout="none">
                            <apex:outputPanel layout="none" styleClass="error-panel" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}">
                                <div id="divToast" class="slds-notify_container slds-is-relative">
                                    <apex:repeat value="{!pageMessagesMap}" var="severity">
                                        <div class="slds-notify slds-notify_toast slds-theme_{!severity}" role="status">
                                            <span class="slds-assistive-text"></span>
                                            <span class="slds-icon_container slds-icon-utility-success slds-m-right_small slds-no-flex slds-align-top">
                                                <span class="slds-icon_container slds-icon__svg--default {!severity}ToastIcon"></span>
                                            </span>
                                            <div class="slds-notify__content">
                                                <apex:repeat value="{!pageMessagesMap[severity]}" var="messages">
                                                    <h2 class="slds-text-heading_small ">{!messages}</h2>
                                                </apex:repeat>
                                            </div>
                                            <div class="slds-notify__close">
                                                <button type="button" class="slds-button slds-button_icon slds-button_icon-inverse" title="{!$Label.CLOSE}" onclick="$copado('[id=divToast]').addClass('slds-hide');">
                                                    <svg class="slds-button__icon" aria-hidden="true">
                                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}" />
                                                    </svg>
                                                    <span class="slds-assistive-text">Help</span>
                                                </button>
                                            </div>
                                        </div>
                                    </apex:repeat>
                                </div>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <div class="slds-grid slds-wrap slds-clearfix">
                            <div id="modalHeader" class="slds-col slds-size_1-of-2">
                                <button class="slds-button" onclick="closeToastMessage(); closeModal(); return false;">
                                    <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                    </svg>
                                    {!$Label.copado__Pipeline_Back_to_Pipeline}
                                </button>
                            </div>
                            <apex:outputPanel id="GeneralActionButtons" styleClass="slds-col slds-size_1-of-2" style="text-align:right;">
                                <apex:commandButton value="{!$Label.copado__Pipeline_Validate_Selections}" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" id="validateSelections" action="{!createPromotionforValidation}" reRender="modalHeader,copadoErrorPanelForDialog,createdPromotionListPanel" onClick="lockScreen();" oncomplete="openPromotionListModal();renderPromotionPoller();" disabled="{!NOT(showUserStories)}" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}"/>
                                <apex:commandButton value="{!IF(newOverlay.pathType == 'merge', $Label.copado__Pipeline_Promote, $Label.copado__Pipeline_Back_Promote)}" styleClass="slds-button slds-button_neutral slds-m-horizontal_small" id="createPromotion" action="{!createPromotion}" reRender="copadoErrorPanel,notify,modalHeader,copadoErrorPanelForDialog,createdPromotionListButtons,createdPromotionListPanel" onClick="lockScreen();" onComplete="openPromotionListModal();" disabled="{!NOT(showUserStories)}" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}"/>
                                <apex:commandButton value="{!IF(newOverlay.pathType == 'merge', $Label.copado__Pipeline_Promote_and_Deploy, $Label.copado__Pipeline_Back_Promote_and_Deploy)}" styleClass="slds-button slds-button_brand slds-m-horizontal_small" id="createPromotionAndDeploy" action="{!createPromotionListAndDeploy}"  onClick="lockScreen();" onComplete="openPromotionListModal();" disabled="{!NOT(showUserStories)}" reRender="modalHeader,copadoErrorPanelForDialog,createdPromotionListPanel,promotionPoller" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}"/>
                                <apex:commandButton value="{!$Label.copado__Create_Promotion}" styleClass="slds-button slds-button_brand slds-m-horizontal_small" id="createMcPromotion" action="{!createPromotion}" reRender="mcPromotionMessages" onClick="lockScreen();" onComplete="unlockScreen();" disabled="{!NOT(showUserStories)}" rendered="{!AND(currentPipeline.copado__Platform__c != 'Salesforce',currentPipeline.copado__Platform__c != null)}"/> 
                            </apex:outputPanel>
                        </div>
                        <div class="slds-grid slds-wrap slds-clearfix">
                            <div id="headtitle" class="slds-col slds-align-middle slds-size_1-of-3">
                                <h2 class="slds-text-heading_medium slds-hyphenate">
                                    {!$Label.User_Stories}
                                </h2>
                            </div>
                            <div class="slds-col slds-align-middle slds-size_1-of-3"></div>
                            <div id="headpicklist" class="slds-col slds-size_1-of-3" style="text-align:right;">
                                <apex:outputPanel layout="none" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}">
                                    <div class="slds-form-element">
                                        <div class="slds-form-element__control" style="float:right;border-bottom: 1px solid gray; width: 30%;min-width:150px;"> <!--min-width is because list cannot be smaller than that-->
                                            <label class="slds-form-element__label" for="testlevelPicklist">{!$Label.Pipeline_Test_Level}</label>
                                            <apex:selectList value="{!testLevel}" id="testlevelPicklist" size="1" disabled="{!newOverlay.toEnvRunAllTests}"
                                                            multiselect="false" styleClass="slds-select" style="border:none;" title="{!IF(newOverlay.toEnvRunAllTests,$Label.copado__Pipeline_Dest_Env_enforces_RunAllTestsInOrg,$Label.copado__Pipeline_Select_Deployment_Testlevel)}">
                                                <apex:selectOption itemValue="NoTestRun" itemLabel="NoTestRun" />
                                                <apex:selectOption itemValue="RunSpecifiedTests" itemLabel="RunSpecifiedTests" />
                                                <apex:selectOption itemValue="RunLocalTests" itemLabel="RunLocalTests" />
                                                <apex:selectOption itemValue="RunAllTestsInOrg" itemLabel="RunAllTestsInOrg" />
                                            </apex:selectList>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                            </div>
                        </div>
                        <apex:outputPanel style="width: 100%; float: left; margin-bottom:10px;margin-top:5px;" layout="block" id="tabHeader">
                            <apex:outputPanel layout="none" rendered="{!newOverlay.pathType == 'merge'}">
                                <span class="slds-text-heading_medium">
                                    {!newOverlay.fromEnvName}
                                    <svg class="slds-button__icon slds-button__icon_right" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#forward')}"></use>
                                    </svg>
                                </span>
                                <span class="slds-text-heading_medium">
                                    {!newOverlay.toEnvName}
                                </span>
                            </apex:outputPanel>
                            <apex:outputPanel layout="none" rendered="{!newOverlay.pathType != 'merge'}">
                                <span class="slds-text-heading_medium">
                                    {!newOverlay.toEnvName}
                                    <svg class="slds-button__icon slds-button__icon_right" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                    </svg>
                                </span>
                                <span class="slds-text-heading_medium">
                                        {!newOverlay.fromEnvName}
                                    </span>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel styleClass="slds-modal__content slds-p-around_medium" id="mcPromotionMessages">
                            <apex:outputPanel layout="none" styleClass="error-panel" rendered="{!AND(currentPipeline.copado__Platform__c != 'Salesforce',currentPipeline.copado__Platform__c != null)}">
                                <div id="divToast" class="slds-notify_container slds-is-relative">
                                    <apex:repeat value="{!pageMessagesMap}" var="severity">
                                        <div class="slds-notify slds-notify_toast slds-theme_{!severity}" role="status">
                                            <span class="slds-assistive-text"></span>
                                            <span class="slds-icon_container slds-icon-utility-success slds-m-right_small slds-no-flex slds-align-top">
                                                <span class="slds-icon_container slds-icon__svg--default {!severity}ToastIcon"></span>
                                            </span>
                                            <div class="slds-notify__content">
                                                <apex:repeat value="{!pageMessagesMap[severity]}" var="messages">
                                                    <h2 class="slds-text-heading_small ">{!messages}</h2>
                                                </apex:repeat>
                                            </div>
                                        </div>
                                    </apex:repeat>
                                </div>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel id="pins" layout="block" styleClass="slds-grid" style="width: 100%; margin-top: 15px;">
                            <apex:outputPanel layout="none" rendered="{!OR(currentPipeline.copado__Platform__c == 'Salesforce',currentPipeline.copado__Platform__c == null)}">
                                <div class="slds-button-group slds-size_1-of-2" style="margin-bottom:20px;" role="group">
                                    <button name="templateButton" class="slds-button slds-button_neutral tabButton activeButton" style="border-bottom: 2px solid #3593c6; border-radius: .25rem 0 0 0;" onclick="lockScreen();toggleCurrentButton(this);switchTab('USERSTORY');" type="button">{!IF(newOverlay.pathType == 'merge',$Label.USER_STORIES_AHEAD,$Label.USER_STORIES_BEHIND)} ({!newOverlay.userStories.size})</button>
                                    <button name="templateButton" class="slds-button slds-button_neutral tabButton" style="border-bottom: 2px solid #3593c6;" onclick="lockScreen();toggleCurrentButton(this);switchTab('SELENIUM');" type="button">{!$Label.STR} (<span id="strsize">{!STGSize}</span>)
                                    </button>
                                    <button name="templateButton" class="slds-button slds-button_neutral tabButton" style="border-bottom: 2px solid #3593c6; border-radius: 0 .25rem 0 0;" onclick="lockScreen();toggleCurrentButton(this);switchTab('COMPLIANCE');" type="button">{!$Label.CSR} (<span id="csrsize">{!CRSize}</span>)
                                    </button>
                                </div>
                                <div id="tabfilter" class="slds-size_1-of-6" style="width: 50%; margin-bottom:20px; border-bottom: 2px solid #3593c6;"></div>
                            </apex:outputPanel>
                            <apex:outputPanel layout="none" rendered="{!AND(currentPipeline.copado__Platform__c != 'Salesforce',currentPipeline.copado__Platform__c != null)}">
                                <div class="slds-button-group slds-size_1-of-6" style="margin-bottom:20px;" role="group">
                                    <button name="templateButton" class="slds-button slds-button_neutral tabButton activeButton" style="border-bottom: 2px solid #3593c6; border-radius: .25rem 0 0 0;" onclick="lockScreen();toggleCurrentButton(this);switchTab('USERSTORY');" type="button">{!IF(newOverlay.pathType == 'merge',$Label.USER_STORIES_AHEAD,$Label.USER_STORIES_BEHIND)} ({!newOverlay.userStories.size})</button>
                                </div>
                                <div id="tabfilter" class="slds-size_5-of-6" style="margin-bottom:20px; border-bottom: 2px solid #3593c6;"></div>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" id="fieldSets">
                            <!-- USER STORIES FIELDSET -->
                            <apex:outputPanel id="userStories" layout="none" rendered="{!showUserStories}">
                                <fieldset class="slds-theme--default slds-container--fluid">
                                    <table class="slds-table slds-table_resizable-cols slds-table_bordered slds-table_striped sortableTable" role="grid" id="userStoriesTable">
                                        <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col" class="slds-text-align_right slds-is-resizable" style="width: 3.25rem;">
                                                <div class="slds-th__action slds-th__action_form">
                                                        <span class="slds-checkbox">
                                                        <input type="checkbox" name="options" id="selectAll" checked="true" onchange="selectUnselectAll('userStoriesTable',this.id);" />
                                                        <label class="slds-checkbox__label" for="selectAll">
                                                            <span class="slds-checkbox_faux"></span>
                                                        <span class="slds-form-element__label slds-assistive-text">{!$Label.SELECT_ALL}</span>
                                                        </label>
                                                        </span>
                                                </div>
                                            </th>
                                            <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__CBM_Fields}" var="fld">
                                                <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                                    <a href="javascript:void(0);" class="slds-th__action slds-text-link_reset" tabindex="0">
                                                        <span class="slds-assistive-text">{!$Label.Sort}</span>
                                                        <span class="slds-truncate" title="Name">{!fld.Label}</span>
                                                        <div class="slds-icon_container"></div>
                                                        <span class="slds-assistive-text" aria-live="assertive" aria-atomic="true"></span>
                                                    </a>
                                                    <div class="slds-resizable">
                                                        <label for="cell-resize-handle-1" class="slds-assistive-text">{!fld.Label} column width</label>
                                                        <input type="range" min="20" max="1000" class="slds-resizable__input slds-assistive-text" id="cell-resize-handle-1" tabindex="0" />
                                                        <span class="slds-resizable__handle" draggable="true" onmousedown="CalculateWidth(this, event)" ondrag="SetNewWidth(this, event)" ondragend="return false;">
                                                            <span class="slds-resizable__divider"></span>
                                                        </span>
                                                    </div>
                                                </th>
                                            </apex:repeat>
                                        </tr>
                                        </thead>
                                        <tbody id="mainTableBody">
                                        <apex:repeat value="{!newOverlay.userStories}" var="us" id="userStoryRepeat">
                                            <tr class="slds-hint-parent">
                                                <td role="gridcell" class="slds-text-align_right" style="width: 3.25rem;">
                                                    <apex:inputCheckbox id="checkbox-2" value="{!us.isSelected}" onClick="changeSelectAll('userStoriesTable', 'selectAll');" />
                                                </td>
                                                <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__CBM_Fields}" var="fld">
                                                    <td role="gridcell" style="max-width:200px;overflow: hidden !important;text-overflow: ellipsis;white-space: nowrap !important;">
                                                        <div class="slds-truncate" title="{!us.userStory[fld]}">
                                                            <apex:outputPanel layout="none" rendered="{!OR(fld.Type == 'reference', AND(fld.Type != 'reference', fld.Label == $ObjectType.copado__User_Story__c.fields.copado__Last_Validation_Deployment_Status__c.Label), fld.Type == 'boolean')}">
                                                                <apex:outputField value="{!us.userStory[fld.fieldPath]}" />
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!AND(fld.Type != 'reference', fld.Label != $ObjectType.copado__User_Story__c.fields.copado__Last_Validation_Deployment_Status__c.Label,fld.Label != $ObjectType.copado__User_Story__c.fields.Name.Label, fld.Type != 'boolean')}">
                                                                {!us.userStory[fld.fieldPath]}
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!AND(fld.Type != 'reference', fld.Label == $ObjectType.copado__User_Story__c.fields.Name.Label)}">
                                                                <a href="#" onclick="copadoNavigateToUrl('{!us.userStory.Id}','{!URLFOR($Action.copado__User_Story__c.View,us.userStory.Id)}', '_blank'); return false;"> {!us.userStory[fld.fieldPath]} </a>
                                                            </apex:outputPanel>
                                                        </div>
                                                    </td>
                                                </apex:repeat>
                                            </tr>
                                        </apex:repeat>
                                        </tbody>
                                    </table>
                                </fieldset>
                            </apex:outputPanel>
                            <!-- END OF USER STORIES FIELDSET -->
                            <!-- COMPLIANCE RESULT FIELDSET -->
                            <apex:outputPanel id="complianceResults" layout="none" rendered="{!showComplianceResults}">
                                <fieldset class="slds-theme--default slds-container--fluid">
                                    <table class="slds-table slds-table_resizable-cols slds-table_bordered slds-table_striped sortableTable" role="grid" id="compliancesTable">
                                        <thead>
                                        <apex:repeat value="{!$ObjectType.copado__Compliance_Scan_Result__c.FieldSets.copado__Compliance_Result_Tab}" var="fld">
                                            <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                                <a href="javascript:void(0);" class="slds-th__action slds-text-link_reset" tabindex="0">
                                                    <span class="slds-assistive-text">{!$Label.Sort}</span>
                                                    <span class="slds-truncate" title="{!fld.Label}">{!fld.Label}</span>
                                                    <div class="slds-icon_container"></div>
                                                    <span class="slds-assistive-text" aria-live="assertive" aria-atomic="true"></span>
                                                </a>
                                                <div class="slds-resizable">
                                                    <label for="cell-resize-handle-1" class="slds-assistive-text">{!$Label.Message_Column_Width}</label>
                                                    <input type="range" min="20" max="1000" class="slds-resizable__input slds-assistive-text" id="cell-resize-handle-1" tabindex="0" />
                                                    <span class="slds-resizable__handle" draggable="true" onmousedown="CalculateWidth(this, event)" ondrag="SetNewWidth(this, event)" ondragend="return false;">
                                                        <span class="slds-resizable__divider"></span>
                                                    </span>
                                                </div>
                                            </th>
                                        </apex:repeat>
                                        </thead>
                                        <tbody>
                                        <apex:repeat value="{!ComplianceScanResults}" var="cr">
                                            <tr class="slds-hint-parent">
                                                <apex:repeat value="{!$ObjectType.copado__Compliance_Scan_Result__c.FieldSets.copado__Compliance_Result_Tab}" var="fld">
                                                    <apex:variable var="isReferenceField" value="{!fld.Type == 'reference'}" />
                                                    <apex:variable var="isBooleanField" value="{!fld.Type == 'boolean'}" />
                                                    <apex:variable var="isNameField" value="{!fld.Label == $ObjectType.copado__Compliance_Scan_Result__c.fields.Name.Label}" />
                                                    <td role="gridcell" class="">
                                                        <div class="slds-truncate" title="{!cr[fld]}">
                                                            <apex:outputPanel layout="none" rendered="{!OR(isReferenceField, isBooleanField)}">
                                                                <apex:outputField value="{!cr[fld.fieldPath]}" />
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!AND(NOT(isReferenceField), NOT(isBooleanField), NOT(isNameField))}">
                                                                {!cr[fld.fieldPath]}
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!isNameField}">
                                                                <a href="#" onclick="copadoNavigateToUrl('{!cr.Id}','{!URLFOR($Action.copado__Compliance_Scan_Result__c.View,cr.Id)}', '_blank'); return false;">{!cr[fld.fieldPath]}</a>
                                                            </apex:outputPanel>
                                                        </div>
                                                    </td>
                                                </apex:repeat>
                                            </tr>
                                        </apex:repeat>
                                        </tbody>
                                    </table>
                                </fieldset>
                            </apex:outputPanel>
                            <!-- END OF COMPLIANCE RESULT FIELDSET -->
                            <!-- SELENIUM RESULT FIELDSET -->
                            <apex:outputPanel id="seleniumResults" layout="none" rendered="{!showSeleniumResults}">
                                <fieldset class="slds-theme--default slds-container--fluid">
                                    <table class="slds-table slds-table_resizable-cols slds-table_bordered slds-table_striped sortableTable" role="grid" id="seleniumsTable">
                                        <thead>
                                        <tr class="slds-line-height_reset">
                                            <apex:repeat value="{!$ObjectType.copado__Selenium_Test_Group__c.FieldSets.copado__Selenium_Results_Tab}" var="fld">
                                                <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col" style="width: 21%">
                                                    <a href="javascript:void(0);" class="slds-th__action slds-text-link_reset" tabindex="0">
                                                        <span class="slds-assistive-text">{!$Label.Sort} </span>
                                                        <span class="slds-truncate" title="{!fld.Label}">{!fld.Label}</span>
                                                    </a>
                                                    <div class="slds-resizable">
                                                        <label for="cell-resize-handle-1" class="slds-assistive-text">{!$Label.Message_Column_Width}</label>
                                                        <input type="range" min="20" max="1000" class="slds-resizable__input slds-assistive-text" id="cell-resize-handle-1" tabindex="0" />
                                                        <span class="slds-resizable__handle" draggable="true" onmousedown="CalculateWidth(this, event)" ondrag="SetNewWidth(this, event)" ondragend="return false;">
                                                            <span class="slds-resizable__divider"></span>
                                                            </span>
                                                    </div>
                                                </th>
                                            </apex:repeat>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <apex:repeat value="{!SeleniumTestGroups}" var="sr">
                                            <tr class="slds-hint-parent">
                                                <apex:repeat value="{!$ObjectType.copado__Selenium_Test_Group__c.FieldSets.copado__Selenium_Results_Tab}" var="fld">
                                                    <td role="gridcell" class="">
                                                        <div class="slds-truncate" title="{!sr[fld]}">
                                                            <apex:outputPanel layout="none" rendered="{!OR(fld.Type == 'reference', AND(fld.Type != 'reference', fld.Label == $ObjectType.copado__Selenium_Test_Group__c.fields.copado__Status_Icon__c.Label), fld.Type == 'boolean')}">
                                                                <apex:outputField value="{!sr[fld.fieldPath]}" />
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!AND(fld.Type != 'reference', fld.Label != $ObjectType.copado__Selenium_Test_Group__c.fields.copado__Status_Icon__c.Label, fld.Type != 'boolean')}">
                                                                {!sr[fld.fieldPath]}
                                                            </apex:outputPanel>
                                                        </div>
                                                    </td>
                                                </apex:repeat>

                                            </tr>
                                        </apex:repeat>
                                        </tbody>
                                    </table>
                                </fieldset>
                                
                            </apex:outputPanel>
                            <!-- END OF SELENIUM RESULT FIELDSET -->
                        </apex:outputPanel>

                    </div>
                </apex:outputPanel>
            </section>
            <div class="slds-backdrop" id="backdrop"></div>
        </apex:outputPanel>

        <!-- Approvals modal -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="approvalModal" aria-labelledby="modal-heading-01" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_large" style="height: 100%">
                <div class="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 85%; height: 100%; overflow-x:scroll;">
                        <apex:outputPanel id="approvalPanelHeader" layout="block">
                            <div id="approvalHeading" style="float: left;margin-bottom:40px">
                                <button class="slds-button" onclick="closeApprovalModal(); return false;">
                                    <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                    </svg>
                                    {!$Label.copado__Pipeline_Back_to_Pipeline}
                                </button>
                                <h2 class="slds-text-heading_medium slds-hyphenate">
                                    {!$Label.copado__Pipeline_Pending_Approvals}
                                </h2>
                            </div>
                            <apex:outputPanel id="approvalRenderPanel" layout="block" style="margin-top:20px">
                                <table id="dt4Approval" class="compact row-border">
                                    <thead>
                                    <tr>
                                        <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__Pipeline_Manager_Pending_Approvals}" var="usf">
                                            <td style="background-color: #fafaf9">
                                                <h2 id="approvalHT" class="slds-text-heading_medium slds-hyphenate" style="padding-left:20px">
                                                    <apex:outputText value="{!usf.Label}" />
                                                </h2>
                                            </td>
                                        </apex:repeat>
                                        <td style="background-color: #fafaf9">
                                            <h2 id="approvalHT" class="slds-text-heading_medium slds-hyphenate" style="padding-left:20px">
                                                {!$Label.Action}
                                            </h2>
                                        </td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <apex:repeat value="{!PendingApprovalsByEnvironment}" var="approval">
                                        <tr>
                                            <apex:repeat value="{!$ObjectType.copado__User_Story__c.FieldSets.copado__Pipeline_Manager_Pending_Approvals}" var="usf">
                                                <td style="padding-left:28px">
                                                    <apex:outputField value="{!approval[usf]}" />
                                                </td>
                                            </apex:repeat>
                                            <td style="padding-left:28px">
                                                <button type="button" onclick="copadoNavigateToUrl('{!approval.Id}','{!URLFOR($Action.User_Story__c.View,approval.Id)}', '_blank');" class="slds-button slds-button_neutral" style="border: none;">
                                                    <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#preview')}"></use>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    </tbody>
                                </table>
                                <script>
                                    function rerenderApprovalDatatable() {
                                        $copado('#dt4Approval').DataTable();
                                    }

                                </script>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop" id="approvalBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF Approvals modal -->

        <!-- Deployment modal -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="deploymentModal" aria-labelledby="modal-heading-01" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_large" style="height: 100%">
                <div class="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 85%; height: 100%; overflow-x:scroll;">
                        <apex:outputPanel id="deploymentPanelHeader" layout="block">
                            <div id="deploymentHeading" style="float: left;margin-bottom:40px">
                                <button class="slds-button" onclick="closeDeploymentModal(); return false;">
                                    <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                    </svg>
                                    {!$Label.copado__Pipeline_Back_to_Pipeline}
                                </button>
                                <h2 class="slds-text-heading_medium slds-hyphenate">
                                    {!$Label.copado__Deployment_Activity}
                                </h2>
                            </div>
                            <apex:outputPanel id="deploymentRenderPanel" layout="block" style="margin-top:20px">
                                <table id="dt4Deployment" class="compact row-border">
                                    <thead>
                                    <tr>
                                        <apex:outputPanel layout="none" rendered="{!AND(currentPipeline.copado__Platform__c != null,currentPipeline.copado__Platform__c != 'Salesforce')}">
                                            <td style="background-color: #fafaf9">
                                                <h2 id="deploymentHT" class="slds-text-title_caps slds-hyphenate" style="padding-left:20px">
                                                    Job Execution
                                                </h2>
                                            </td>
                                        </apex:outputPanel>
                                        <apex:repeat value="{!$ObjectType.copado__Deployment__c.FieldSets.copado__Pipeline_Deployment_Modal}" var="usf">
                                            <td style="background-color: #fafaf9">
                                                <h2 id="deploymentHT" class="slds-text-title_caps slds-hyphenate" style="padding-left:20px">
                                                    <apex:outputText value="{!usf.Label}" />
                                                </h2>
                                            </td>
                                        </apex:repeat>
                                        <td style="background-color: #fafaf9">
                                            <h2 id="deploymentHT" class="slds-text-title_caps slds-hyphenate" style="padding-left:20px">
                                                {!$Label.Action}
                                            </h2>
                                        </td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <apex:repeat value="{!LatestDeploymentsByEnvironment}" var="deployment">
                                        <tr>
                                            <apex:outputPanel layout="none" rendered="{!AND(currentPipeline.copado__Platform__c != null,currentPipeline.copado__Platform__c != 'Salesforce')}">
                                                <td style="padding-left:28px">
                                                    <apex:repeat value="{!deployment.JobExecutions__r}" var="executions">
                                                        <a href="#" onclick="copadoNavigateToUrl('{!executions.Id}','{!URLFOR($Action.copado__JobExecution__c.View,executions.Id)}', '_blank'); return false;"> {!executions.Name} </a>
                                                    </apex:repeat>
                                                </td>
                                            </apex:outputPanel>
                                            <apex:repeat value="{!$ObjectType.copado__Deployment__c.FieldSets.copado__Pipeline_Deployment_Modal}" var="dep">
                                                <td style="padding-left:28px">
                                                    <apex:outputPanel layout="none" rendered="{!dep.Label == $ObjectType.copado__Deployment__c.fields.Name.Label}">
                                                        <a href="#" onclick="copadoNavigateToUrl('{!deployment.Id}','{!URLFOR($Action.copado__Deployment__c.View,deployment.Id)}', '_blank'); return false;"> {!deployment[dep.fieldPath]} </a>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel layout="none" rendered="{!dep.Label != $ObjectType.copado__Deployment__c.fields.Name.Label}">
                                                        <apex:outputField value="{!deployment[dep]}" rendered="{!dep.Label != $ObjectType.copado__Deployment__c.fields.copado__Flag_Status__c.Label}"/>
                                                    </apex:outputPanel>
                                                    <apex:image url="{!deployment[dep]}" rendered="{!dep.Label == $ObjectType.copado__Deployment__c.fields.copado__Flag_Status__c.Label}" height="20" width="20"/>
                                                </td>
                                            </apex:repeat>
                                            <td style="padding-left:28px">
                                                <apex:outputPanel layout="none" rendered="{!deployment.Promotion__r.copado__Status__c == 'Merge Conflict'}">
                                                    <a href="javascript:void(0)" target="_blank" class="slds-button" onclick="openConflictPage('{!deployment.Promotion__c}');return false;" style="border: none;">{!$Label.MERGE_CONFLICT_REVIEW}
                                                    </a>
                                                </apex:outputPanel>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    </tbody>
                                </table>
                                <script>
                                    function rerenderDeploymentDatatable() {
                                        $copado('#dt4Deployment').DataTable({"order": []});
                                    }
                                </script>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop" id="deploymentBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF Deployments modal -->

        <!-- START OF Dependencies Panel -->
        <apex:outputPanel layout="block" id="dependencyUSComponent" style="display: none;" styleClass="slds-scope">
            <div class="slds-modal_large">
                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
                         aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open" style="height:100%">
                    <div class="slds-modal__container">
                        <header class="slds-modal__header">
                            <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                                    title="Close" onclick="closeUSDep(); return false;">
                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink"
                                         xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#close')}"></use>
                                </svg>
                                <span class="slds-assistive-text">{!$Label.CLOSE}</span>
                            </button>
                            <h2 id="modal-heading-01"
                                class="slds-text-heading_medium slds-hyphenate">{!$label.USDependency_USDependenciesTitle}</h2>
                        </header>
                        <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                            <apex:outputPanel rendered="{!currentProId4Dependency!=null}">
                                <c:UserStoryDependency usMap="{!userStoriesByPromotionForDependencies}" proId="{!currentProId4Dependency}" />
                            </apex:outputPanel>
                        </div>
                    </div>
                </section>
            </div>
            <div class="slds-backdrop slds-backdrop_open" id="USbackdrop"></div>
        </apex:outputPanel>
        <!-- END OF Dependencies Panel -->

        <!-- START Promotion List modal -->
        <apex:outputPanel layout="none">
            <section role="dialog" tabindex="-1" id="promotionListModal" class="slds-modal slds-modal_large" style="height: 100%">
                <div class="slds-modal__container" style="width: 100% !important;">
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1" style="min-height: 70%; height: 100%; overflow-x:scroll;">
                        <div style="float:left; margin-bottom: 10px;" id="head">
                            <button class="slds-button" onclick="lockScreen();resetPromotionList(); return false;">
                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#back')}"></use>
                                </svg>{!$Label.copado__CLOSE}</button>
                            <apex:outputPanel id="promotionsHeader" layout="block">
                                <h2 id="logsHeaderText" class="slds-text-heading_medium slds-hyphenate">
                                    <apex:outputText value="{!$Label.copado__Pipeline_Created_Promotions}" />
                                </h2>
                            </apex:outputPanel>
                        </div>
                        <apex:outputPanel id="createdPromotionListButtons" layout="block" style="float: right">
                            <apex:outputPanel rendered="{!promotionListOnly}">
                                <button class="slds-button slds-button_neutral" onclick="lockScreen();resetPromotionList(); return false;">{!$Label.copado__Prepare_Another_Promotion}</button>
                                <button class="slds-button slds-button_brand" id="depPros" onclick="lockScreen();deployPromotionList(); return false;">{!$Label.copado__Deploy_Promotions}</button>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:actionPoller action="{!checkPromotionsStatuses}" id="promotionPoller" enabled="{!enabledPromotionBackPromotionPoller}" interval="10" reRender="createdPromotionListPanel,promotionPoller, createdPromotionListButtons" />
                        <apex:outputPanel layout="block" id="createdPromotionListPanel">
                            <table id="promolist" class="slds-table slds-table_resizable-cols slds-table_striped">
                                <thead>
                                <tr>
                                    <th class="slds-text-align_right slds-is-resizable" scope="col" style="width: 3.25rem;">
                                        <div class="slds-th__action slds-th__action_form">
                                            <span class="slds-checkbox">
                                            <input type="checkbox" name="options" id="selectUnselectPromo" value="checkbox-2" checked="true" onchange="selectUnselectAll('promolist', this.id);" />
                                            <label class="slds-checkbox__label" for="selectUnselectPromo">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label slds-assistive-text">{!$Label.SELECT_ALL}</span>
                                            </label>
                                        </span>
                                        </div>
                                    </th>
                                    <apex:repeat value="{!$ObjectType.copado__Promotion__c.FieldSets.copado__Pipeline_Manager}" var="pf">
                                        <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                            <apex:outputLabel value="{!pf.Label}" />
                                        </th>
                                    </apex:repeat>
                                    <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                        <b>{!$Label.copado__Pipeline_Test_Level}</b>
                                    </th>
                                    <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                        <b>{!$Label.copado__DEPLOYMENT_STATUS}</b>
                                    </th>
                                    <th class="slds-is-sortable slds-is-resizable slds-text-title_caps" scope="col">
                                        <b>{!$Label.copado__Pipeline_Dependency_Status}</b>
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                <apex:repeat var="prom" value="{!promotionWrappers}">
                                    <tr>
                                        <td style="text-align: center">
                                            <apex:inputCheckbox value="{!prom.isSelected}" onClick="changeSelectAll('promolist', 'selectUnselectPromo');" />
                                        </td>
                                        <apex:repeat value="{!$ObjectType.copado__Promotion__c.FieldSets.copado__Pipeline_Manager}" var="pf">
                                            <td class="slds-is-resizable">
                                                <apex:outputPanel layout="none" rendered="{!OR(pf.Type == 'reference', pf.Type == 'boolean')}">
                                                    <apex:outputField value="{!prom.promotion[pf.fieldPath]}" />
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!AND(pf.Type != 'reference', pf.Label != $ObjectType.copado__Promotion__c.fields.Name.Label, pf.Type != 'boolean')}">
                                                    {!prom.promotion[pf.fieldPath]}
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!AND(pf.Type != 'reference', pf.Label == $ObjectType.copado__Promotion__c.fields.Name.Label)}">
                                                    <a href="#" onclick="copadoNavigateToUrl('{!prom.promotion.Id}','{!URLFOR($Action.copado__Promotion__c.View,prom.promotion.Id)}', '_blank'); return false;"> {!prom.promotion[pf.fieldPath]}</a>
                                                </apex:outputPanel>
                                            </td>
                                        </apex:repeat>
                                        <td class="slds-is-resizable">
                                            <apex:outputText value="{!prom.promotionTestLevel}" />
                                        </td>
                                        <td style="text-align: center;" class="slds-is-resizable">
                                            <apex:outputPanel layout="none" rendered="{!prom.promotion.copado__Status__c == 'Scheduled'}">
                                                <div id="statusImg" class="slds-icon_container">
                                                    <svg class="slds-icon slds-icon_small slds-icon-text-default" aria-hidden="true">
                                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#clock')}">
                                                        </use>
                                                    </svg>
                                                </div>
                                                <script type="text/javascript">
                                                    $copado(function(){
                                                        var item = $copado('[Id$=statusImg]');
                                                        item.html("");
                                                        var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#clock')}";
                                                        var SVG = $copado('<svg/>', {
                                                            class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                        });
                                                        var SVGUse = $copado('<use/>');
                                                        SVGUse.attr('xlink:href', imageURL);
                                                        item.prepend(SVG.append(SVGUse));
                                                        item.html(item.html());
                                                    });

                                                </script>
                                            </apex:outputPanel>
                                            <apex:outputPanel layout="none" rendered="{!prom.promotion.copado__Status__c == 'In Progress'}">
                                                <img id="statusImg" style="width: 20px;" src="{!URLFOR($Resource.SLDS,'assets/images/spinners/slds_spinner_brand.gif')}" />
                                            </apex:outputPanel>
                                            <apex:outputPanel layout="none" rendered="{!prom.promotion.copado__Status__c == 'Completed' || prom.promotion.copado__Status__c == 'Validated'}">
                                                <div id="statusImgApproval" class="slds-icon_container">
                                                    <svg class="slds-icon slds-icon_small slds-icon-text-default" aria-hidden="true">
                                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/action-sprite/svg/symbols.svg#approval')}">
                                                        </use>
                                                    </svg>
                                                </div>
                                                <script type="text/javascript">
                                                    $copado(function(){
                                                        var item = $copado('[Id$=statusImgApproval]');
                                                        item.html("");
                                                        var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/action-sprite/svg/symbols.svg#approval')}";
                                                        var SVG = $copado('<svg/>', {
                                                            class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                        });
                                                        var SVGUse = $copado('<use/>');
                                                        SVGUse.attr('xlink:href', imageURL);
                                                        item.prepend(SVG.append(SVGUse));
                                                        item.html(item.html());
                                                    });
                                                </script>
                                            </apex:outputPanel>
                                            <apex:outputPanel layout="none" rendered="{!prom.promotion.copado__Status__c == 'Completed with errors' || prom.promotion.copado__Status__c == 'Validated with errors'}">
                                                <div id="statusImgClose" class="slds-icon_container">
                                                    <svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
                                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/action-sprite/svg/symbols.svg#close')}">
                                                        </use>
                                                    </svg>
                                                </div>
                                                <script type="text/javascript">
                                                    $copado(function(){
                                                        var item = $copado('[Id$=statusImgClose]');
                                                        item.html("");
                                                        var imageURL = "{!URLFOR($Resource.copado__SLDS,'/assets/icons/action-sprite/svg/symbols.svg#close')}";
                                                        var SVG = $copado('<svg/>', {
                                                            class: 'slds-icon slds-icon_small slds-icon-text-default',
                                                        });
                                                        var SVGUse = $copado('<use/>');
                                                        SVGUse.attr('xlink:href', imageURL);
                                                        item.prepend(SVG.append(SVGUse));
                                                        item.html(item.html());
                                                    });
                                                </script>
                                            </apex:outputPanel>
                                        </td>
                                        <td class="slds-is-resizable">
                                            <apex:outputPanel rendered="{!prom.hasDependency}">
                                                <script>
                                                    $copado('[Id$="depPros"]').addClass('WarningColor');
                                                </script>
                                                <center>
                                                    <a id="warningLink" style="padding-top: 4px;" html-proId="{!prom.promotion.Id}" title="{!$Label.USDependency_IconTitle}" onclick="openUSDep(this);" styleClass="icon-blinker">
                                                        <svg class="slds-icon slds-icon-text-warning slds-icon_small" aria-hidden="true">
                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#warning')}"></use>
                                                        </svg>
                                                    </a>
                                                </center>
                                            </apex:outputPanel>
                                            <apex:outputPanel rendered="{!!prom.hasDependency}">
                                                <center>{!$Label.copado__N_A}</center>
                                            </apex:outputPanel>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                </tbody>
                            </table>
                            <script>
                                $copado(function renderPromoListDatatable(){
                                    $copado('#promolist').DataTable({
                                        "pageLength": 100,
                                        "lengthChange": false,
                                        "ordering": false,
                                        "searching":false
                                    } );
                                });
                            </script>
                        </apex:outputPanel>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop" id="promoListBackdrop"></div>
        </apex:outputPanel>
        <!-- END OF PIPELINE DIALOG -->

        </apex:form>
    </div>
</apex:page>